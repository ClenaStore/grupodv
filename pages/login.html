<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="../assets/styles.css">
  <script src="../assets/auth.js"></script>
</head>
<body>
  <header>
    <div class="head-wrap">
      <a class="brand" href="../index.html"><img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo"><div class="title">Login</div></a>
      <div class="head-spacer"></div>
      <a class="icon-btn only-desktop" href="../index.relatorios.html">üìÑ Relat√≥rios</a>
      <button id="themeToggle" class="icon-btn" type="button">üåì Tema</button>
      <div class="user" id="userMenu"><button class="user-btn"><img src="https://www.w3schools.com/howto/img_avatar.png"><strong style="font-size:13px">Leonardo</strong></button><div class="user-menu"><a href="../perfil.html">üë§ Meu Perfil</a><button onclick="handleLogout()">üö™ Sair</button></div></div>
    </div>
  </header>

  <section class="container">
    <div class="card-panel">
      <div class="panel-head">
        <div class="title-sm">Per√≠odo</div>
        <div style="display:flex; gap:8px; align-items:center">
          <button id="btnRange" class="btn">Selecionar</button>
          <span id="lblRange" style="color:var(--muted); font-weight:800"></span>
        </div>
      </div>
      <div id="legacy-content"><div class="wrap">
    <div class="card" id="card">
      <div class="brand">
        <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo" />
        <h1>Entrar</h1>
      </div>
      <div class="muted">Use seu usu√°rio e senha. A valida√ß√£o ocorre no servidor (planilha privada).</div>

      <form id="form">
        <label for="usuario">Usu√°rio</label>
        <input id="usuario" name="usuario" autocomplete="username" autocapitalize="none" inputmode="text" required />

        <label for="senha">Senha</label>
        <div class="field">
          <input id="senha" name="senha" type="password" autocomplete="current-password" required />
          <button class="toggle" type="button" id="toggle">mostrar</button>
        </div>

        <label class="remember" title="Mant√©m a sess√£o ativa neste aparelho">
          <input type="checkbox" id="remember" />
          Manter conectado
        </label>

        <div class="row">
          <button class="btn" id="btn" type="submit">Entrar</button>
        </div>
        <div class="err" id="err"></div>
        <div class="ok" id="ok"></div>
      </form>

      <div class="footer">Dica: em computador compartilhado, desmarque ‚Äúmanter conectado‚Äù.</div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const WEBAPP = '/api/login_api';

    // ====== Helpers ======
    const qs = (id)=>document.getElementById(id);
    const setBusy = (b)=>{ qs('btn').disabled=b; qs('btn').textContent=b?'Verificando‚Ä¶':'Entrar'; }
    const showErr = (m)=>{ const el=qs('err'); el.textContent=m||''; el.style.display=m?'block':'none'; qs('ok').style.display='none'; }
    const showOk  = (m)=>{ const el=qs('ok');  el.innerHTML=m||''; el.style.display=m?'block':'none'; qs('err').style.display='none'; }

    function getRedirectUrl(){
      const cur = new URL(location.href);
      const next = cur.searchParams.get('next');
      const base = cur.href.slice(0, cur.href.lastIndexOf('/') + 1);
      const def  = base + 'index.html';
      try { return next ? new URL(next, cur).href : def; } catch { return def; }
    }
    function hardRedirect(dest){
      // remove login do hist√≥rico
      location.replace(dest);
      // fallback: se algum navegador ignorar o replace
      setTimeout(()=>{ if (/login\.html?/i.test(location.href)) location.href = dest; }, 150);
    }

    function deviceId(){
      const k='dv_device_id';
      let v=localStorage.getItem(k);
      if(!v){ v=(crypto.randomUUID?.() || (Date.now().toString(36)+Math.random().toString(36).slice(2))); localStorage.setItem(k,v); }
      return v;
    }
    function saveSession(j){
      localStorage.setItem('auth_token', j.token);
      localStorage.setItem('auth_user', JSON.stringify({usuario:j.usuario, empresa:j.empresa, perfil:j.perfil}));
    }

    // ====== SKIP LOGIN SE J√Å TEM SESS√ÉO ======
    (function skipIfLogged(){
      if (localStorage.getItem('auth_token')) {
        hardRedirect(getRedirectUrl());
      }
    })();

    // UI
    qs('toggle').addEventListener('click', ()=>{
      const f=qs('senha'); const isPw=f.type==='password';
      f.type = isPw ? 'text' : 'password';
      qs('toggle').textContent = isPw ? 'ocultar' : 'mostrar';
      f.focus();
    });

    // ====== LOGIN ======
    qs('form').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      showErr(''); showOk('');
      const usuario = qs('usuario').value.trim();
      const senha   = qs('senha').value;
      const remember= qs('remember').checked;
      if(!usuario || !senha){ showErr('Preencha usu√°rio e senha.'); return; }

      setBusy(true);
      try{
        const r = await fetch(`${WEBAPP}?fn=login`, {
          method:'POST',
          headers:{ 'Content-Type':'text/plain;charset=UTF-8' }, // sem preflight
          body: JSON.stringify({
            usuario, senha, remember,
            device: { id:deviceId(), ua:navigator.userAgent, w:innerWidth, h:innerHeight }
          })
        });
        const raw = await r.text();
        let j; try{ j=JSON.parse(raw); }catch{ showErr('Resposta inv√°lida do servidor.'); setBusy(false); return; }

        if (j.status === 'pending'){
          showOk('‚úÖ Dispositivo registrado. Aguarde o administrador liberar este aparelho e tente novamente.');
          setBusy(false);
          return;
        }
        if (!j.ok){
          if(j.error==='blocked') showErr(`Muitas tentativas. Tente novamente em ${j.minutes} min.`);
          else if(j.error==='invalid_credentials') showErr('Usu√°rio ou senha inv√°lidos.');
          else showErr('N√£o foi poss√≠vel entrar agora.');
          setBusy(false);
          return;
        }

        saveSession(j);
        const dest = getRedirectUrl();
        showOk(`Acesso autorizado. Redirecionando‚Ä¶ Se n√£o for autom√°tico, <a href="${dest}">clique aqui</a>.`);
        setTimeout(()=>hardRedirect(dest), 80);
      }catch{
        showErr('Falha de rede. Tente novamente.');
      }finally{
        setBusy(false);
      }
    });
  </script></div>
    </div>
  </section>

  <script src="../assets/ui.js"></script>
  <script src="../assets/daterange.js"></script>
  <script>
    let currentRange=null;
    window.addEventListener('DOMContentLoaded', ()=>{
      attachDateRange({
        button:'#btnRange',
        label:'#lblRange',
        onChange:(rng)=>{ currentRange=rng; console.log('Per√≠odo selecionado', rng); }
      });
    });
  </script>
</body>
</html>
