<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>An√°lise Couvert x M√∫sicos</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0b1020; --surface:#10172a; --card:#0f172a; --text:#e5e7eb;
      --muted:#94a3b8; --line:rgba(148,163,184,.25);
      --shadow:0 20px 60px rgba(2,6,23,.35);
      --ok:#16a34a; --bad:#dc2626;
    }
    body{margin:0;font-family:ui-sans-serif,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}

    /* Cabe√ßalho unificado */
    header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(160%) blur(8px);
      background:color-mix(in srgb, var(--surface) 92%, transparent);border-bottom:1px solid var(--line);}
    .head{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .brand img{height:42px}
    .title{font-weight:800;font-size:clamp(18px,1.6vw,22px)}
    .grow{flex:1}

    .container{max-width:1200px;margin:0 auto;padding:20px 18px}

    /* Cards */
    #painel{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;cursor:pointer;
      transition:.2s;text-align:center}
    .card:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
    .card h2{margin:0 0 6px;font-size:1rem;color:var(--muted)}
    .card p{margin:4px 0;font-size:.95rem}
    .lucro{border-left:6px solid var(--ok);}
    .prejuizo{border-left:6px solid var(--bad);}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:50;padding:18px}
    .modal.open{display:flex}
    .modal-card{background:var(--surface);border:1px solid var(--line);border-radius:14px;width:min(800px,96vw);max-height:92vh;overflow:auto;padding:16px}
    .modal-h{display:flex;align-items:center;margin-bottom:12px}
    .modal-h h3{margin:0}
    .close{margin-left:auto;cursor:pointer;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{background:var(--card);color:var(--muted)}
  </style>
</head>
<body>
  <!-- Cabe√ßalho -->
  <header>
    <div class="head">
      <a class="brand" href="#">
        <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo">
        <span class="title">An√°lise Couvert x M√∫sicos</span>
      </a>
      <div class="grow"></div>
      <button id="reloadBtn" class="btn">üîÑ Atualizar</button>
    </div>
  </header>

  <!-- Conte√∫do -->
  <div class="container">
    <div id="painel"></div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-card">
      <div class="modal-h">
        <h3 id="modalTitle">Detalhes</h3>
        <span id="closeModal" class="close">‚úï</span>
      </div>
      <table>
        <thead><tr><th>Cantor</th><th>Pagamento</th></tr></thead>
        <tbody id="modalTable"></tbody>
      </table>
      <p id="modalCouvert" style="margin-top:14px;font-weight:700"></p>
      <p id="modalResultado" style="margin-top:6px"></p>
    </div>
  </div>

<script>
const API_AGENDA = "https://script.google.com/macros/s/AKfycbxJwRXw2lr2kK58EoHv-oUagd2FV2hvTHXRDJ5mFcNo5eZp3QlX7wX2KdrujAE5zPU-/exec";
const API_COUVERT = "https://script.google.com/macros/s/AKfycbxxv-9kLzyqS9Qy8WX_qPp7UG8He3OaEbIxZMV3HoRaSpdBfRYqZZZODLQlIJZDufso/exec";

let dadosAgenda=[], dadosCouvert=[];
const painel=document.getElementById("painel");
const modal=document.getElementById("modal"), modalTitle=document.getElementById("modalTitle"),
      modalTable=document.getElementById("modalTable"), modalCouvert=document.getElementById("modalCouvert"),
      modalResultado=document.getElementById("modalResultado");

const BRL=n=>(Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fmtData=d=>new Date(d).toLocaleDateString('pt-BR');

async function carregar(){
  painel.innerHTML="<p>Carregando...</p>";
  try{
    const [r1,r2] = await Promise.all([fetch(API_AGENDA), fetch(API_COUVERT)]);
    dadosAgenda = await r1.json();
    dadosCouvert = await r2.json();
    render();
  }catch(e){
    console.error(e);
    painel.innerHTML="<p>Erro ao carregar dados</p>";
  }
}

function render(){
  painel.innerHTML="";
  // Agrupar agenda por empresa+data
  const grupos={};
  dadosAgenda.forEach(ev=>{
    const key=ev.empresa+"|"+ev.data.split("T")[0];
    if(!grupos[key]) grupos[key]={empresa:ev.empresa,data:ev.data.split("T")[0],pagamentos:[],totalPago:0};
    grupos[key].pagamentos.push({cantor:ev.cantor,valor:+ev.valor||0});
    grupos[key].totalPago+=+ev.valor||0;
  });

  // Mapear couvert
  const couvertMap={};
  (dadosCouvert.registros||[]).forEach(c=>{
    const key=c.empresa+"|"+c.data;
    couvertMap[key]=+c.total_dia||0;
  });

  // Criar cards
  Object.values(grupos).forEach(gr=>{
    const couvert=couvertMap[gr.empresa+"|"+gr.data]||0;
    const resultado=couvert-gr.totalPago;
    const card=document.createElement("div");
    card.className="card "+(resultado>=0?"lucro":"prejuizo");
    card.innerHTML=`
      <h2>${gr.empresa} ‚Äì ${fmtData(gr.data)}</h2>
      <p>üé§ Pago m√∫sicos: <b>${BRL(gr.totalPago)}</b></p>
      <p>üéüÔ∏è Couvert: <b>${BRL(couvert)}</b></p>
      <p>${resultado>=0?"‚úÖ Lucro":"‚ùå Preju√≠zo"}: <b>${BRL(resultado)}</b></p>
    `;
    card.onclick=()=>abrirModal(gr, couvert, resultado);
    painel.appendChild(card);
  });
}

function abrirModal(gr, couvert, resultado){
  modalTitle.textContent=`${gr.empresa} ‚Äì ${fmtData(gr.data)}`;
  modalTable.innerHTML=gr.pagamentos.map(p=>`<tr><td>${p.cantor}</td><td>${BRL(p.valor)}</td></tr>`).join("");
  modalCouvert.textContent="üéüÔ∏è Couvert arrecadado: "+BRL(couvert);
  modalResultado.textContent=(resultado>=0?"‚úÖ Lucro: ":"‚ùå Preju√≠zo: ")+BRL(resultado);
  modalResultado.style.color=resultado>=0?"var(--ok)":"var(--bad)";
  modal.classList.add("open");
}
document.getElementById("closeModal").onclick=()=>modal.classList.remove("open");
document.getElementById("reloadBtn").onclick=carregar;

carregar();
</script>
</body>
</html>
