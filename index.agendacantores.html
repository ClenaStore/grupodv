<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>AnÃ¡lise Agenda Financeira</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b1020; --surface:#10172a; --card:#0f172a; --text:#e5e7eb;
      --muted:#94a3b8; --line:rgba(148,163,184,.25);
      --shadow:0 20px 60px rgba(2,6,23,.35);
      --brand:#60a5fa; --brand2:#22d3ee;
      --ok:#16a34a; --bad:#dc2626;
    }
    body{margin:0; font-family:ui-sans-serif,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
    header{position:sticky;top:0;z-index:40;background:var(--surface);border-bottom:1px solid var(--line);}
    .head{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .brand img{height:40px}
    .title{font-weight:800;font-size:20px}
    .grow{flex:1}
    .btn{border:1px solid var(--line);background:var(--surface);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer}
    .btn:hover{box-shadow:var(--shadow)}

    .container{max-width:1200px;margin:0 auto;padding:18px}

    /* Cards */
    #painel{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;text-align:center;cursor:pointer;transition:.2s}
    .card:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
    .card h2{margin:0 0 6px;font-size:1.1rem}
    .card p{margin:3px 0;color:var(--muted);font-size:.95rem}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:50;padding:18px}
    .modal.open{display:flex}
    .modal-card{background:var(--surface);border:1px solid var(--line);border-radius:14px;width:min(1000px,96vw);max-height:92vh;overflow:auto;padding:16px}
    .modal-h{display:flex;align-items:center;margin-bottom:12px}
    .modal-h h3{margin:0}
    .close{margin-left:auto;cursor:pointer;color:var(--muted)}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{background:var(--card);color:var(--muted)}

    .chart-box{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:20px}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="head">
      <a class="brand" href="#">
        <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo">
        <span class="title">AnÃ¡lise Agenda Financeira</span>
      </a>
      <div class="grow"></div>
      <select id="empresaFiltro" class="btn">
        <option value="">Todas Empresas</option>
      </select>
      <button id="filtrarBtn" class="btn">Filtrar</button>
    </div>
  </header>

  <div class="container">
    <!-- Cards -->
    <div id="painel"></div>

    <!-- GrÃ¡fico -->
    <div id="graficoContainer" class="chart-box" style="display:none">
      <h3>ðŸ“ˆ EvoluÃ§Ã£o</h3>
      <canvas id="grafico"></canvas>
    </div>
  </div>

  <!-- Modal detalhes -->
  <div id="modal" class="modal">
    <div class="modal-card">
      <div class="modal-h">
        <h3 id="modalTitle">Detalhes</h3>
        <span id="closeModal" class="close">âœ•</span>
      </div>
      <table>
        <thead><tr><th>Data</th><th>Cantor</th><th>Hora</th><th>Valor</th></tr></thead>
        <tbody id="modalTable"></tbody>
      </table>
    </div>
  </div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbxJwRXw2lr2kK58EoHv-oUagd2FV2hvTHXRDJ5mFcNo5eZp3QlX7wX2KdrujAE5zPU-/exec";
const painel=document.getElementById("painel");
const selectEmpresa=document.getElementById("empresaFiltro");
const modal=document.getElementById("modal"), modalTable=document.getElementById("modalTable"), modalTitle=document.getElementById("modalTitle");
let chart=null, todos=[];

const BRL=n=>(Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fmtData=iso=>new Date(iso).toLocaleDateString('pt-BR');
const fmtHora=iso=>{let d=new Date(iso);return d instanceof Date&&!isNaN(d)? d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}): iso;}

async function carregar(){
  const resp=await fetch(API_URL); todos=await resp.json();
  preencherEmpresas();
  render();
}
function preencherEmpresas(){
  const empresas=[...new Set(todos.map(e=>e.empresa))];
  selectEmpresa.innerHTML='<option value="">Todas Empresas</option>'+empresas.map(e=>`<option>${e}</option>`).join("");
}
function render(){
  painel.innerHTML="";
  let dados=todos;
  const emp=selectEmpresa.value;
  if(emp) dados=dados.filter(d=>d.empresa===emp);

  const porEmpresa={};
  dados.forEach(d=>{
    porEmpresa[d.empresa]??={total:0, itens:[]};
    porEmpresa[d.empresa].total+=Number(d.valor)||0;
    porEmpresa[d.empresa].itens.push(d);
  });

  Object.entries(porEmpresa).forEach(([empresa,info])=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`<h2>${empresa}</h2><p>Total: <strong>${BRL(info.total)}</strong></p><p>Eventos: ${info.itens.length}</p>`;
    div.onclick=()=>abrirModal(empresa,info.itens);
    painel.appendChild(div);
  });

  if(emp) mostrarGrafico(dados); else hideGrafico();
}
function abrirModal(empresa,itens){
  modalTitle.textContent="Detalhes â€” "+empresa;
  modalTable.innerHTML=itens.map(d=>`<tr><td>${fmtData(d.data)}</td><td>${d.cantor}</td><td>${fmtHora(d.hora)}</td><td>${BRL(d.valor)}</td></tr>`).join("");
  modal.classList.add("open");
}
document.getElementById("closeModal").onclick=()=>modal.classList.remove("open");

function mostrarGrafico(dados){
  document.getElementById("graficoContainer").style.display="block";
  dados.sort((a,b)=>new Date(a.data)-new Date(b.data));
  const labels=dados.map(d=>fmtData(d.data));
  const vals=dados.map(d=>Number(d.valor)||0);
  const ctx=document.getElementById("grafico").getContext("2d");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:"line",data:{labels,datasets:[{label:"Faturamento",data:vals,borderColor:"#60a5fa",backgroundColor:"rgba(96,165,250,.2)",fill:true,tension:.25}]}});
}
function hideGrafico(){ if(chart) chart.destroy(); chart=null; document.getElementById("graficoContainer").style.display="none"; }

document.getElementById("filtrarBtn").onclick=()=>render();
carregar();
</script>
</body>
</html>
