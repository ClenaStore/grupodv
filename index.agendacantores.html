<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Couvert x M√∫sicos - Grupo DV</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0b1020; --surface:#10172a; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --line:rgba(148,163,184,.25); --icon-bg:rgba(255,255,255,.06);
      --shadow:0 20px 60px rgba(2,6,23,.35); --brand:#60a5fa; --brand2:#22d3ee;
      --ok:#16a34a; --bad:#dc2626;
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --surface:#fff; --card:#fff; --text:#0f172a; --muted:#475569;
      --line:#e5e7eb; --icon-bg:rgba(2,6,23,.06); --shadow:0 16px 36px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}

    /* Header */
    header{position:sticky; top:0; z-index:40; backdrop-filter:saturate(160%) blur(8px);
      background:color-mix(in srgb, var(--surface) 80%, transparent); border-bottom:1px solid var(--line);}
    .head{max-width:1200px; margin:0 auto; padding:14px 18px; display:flex; align-items:center; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit}
    .brand img{height:42px}
    .title{font-weight:800; font-size:clamp(18px,1.6vw,22px)}
    .grow{flex:1}
    .btn{border:1px solid var(--line); background:var(--surface); color:var(--text);
      padding:10px 12px; border-radius:12px; font-weight:800; cursor:pointer; display:inline-flex; gap:8px; align-items:center}
    .btn:hover{box-shadow:var(--shadow); transform:translateY(-1px)}
    .user{position:relative}
    .user-btn{display:flex; align-items:center; gap:10px; border:1px solid var(--line);
      background:var(--surface); padding:6px 8px; border-radius:999px; cursor:pointer}
    .user-btn img{width:34px; height:34px; border-radius:50%; object-fit:cover; background:var(--icon-bg)}
    .user-menu{position:absolute; right:0; top:110%; background:var(--surface); border:1px solid var(--line);
      border-radius:12px; min-width:200px; padding:6px; box-shadow:var(--shadow); display:none}
    .user.open .user-menu{display:block}
    .user-menu a,.user-menu button{display:flex; width:100%; padding:10px 12px; border-radius:10px;
      border:none; background:transparent; color:var(--text); text-align:left; cursor:pointer; font-weight:600}
    .user-menu a:hover,.user-menu button:hover{background:var(--icon-bg)}

    .container{max-width:1200px;margin:0 auto;padding:20px 18px}
    #painel{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;text-align:center;cursor:pointer;transition:.2s}
    .card:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
    .card h2{margin:0 0 6px;font-size:1rem;color:var(--muted)}
    .card p{margin:4px 0;font-size:.95rem}
    .lucro{border-left:6px solid var(--ok);}
    .prejuizo{border-left:6px solid var(--bad);}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:50;padding:18px}
    .modal.open{display:flex}
    .modal-card{background:var(--surface);border:1px solid var(--line);border-radius:14px;width:min(800px,96vw);max-height:92vh;overflow:auto;padding:16px}
    .modal-h{display:flex;align-items:center;margin-bottom:12px}
    .modal-h h3{margin:0}
    .close{margin-left:auto;cursor:pointer;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{background:var(--card);color:var(--muted)}
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="head">
      <a class="brand" href="index.html" aria-label="In√≠cio">
        <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo">
        <span class="title">Couvert x M√∫sicos</span>
      </a>
      <div class="grow"></div>
      <a class="btn only-desktop" href="index.relatorios.html">üìÑ Relat√≥rios</a>
      <button id="themeToggle" class="btn">üåì Tema</button>
      <div class="user" id="userMenu">
        <button class="user-btn" type="button">
          <img src="https://github.com/ClenaStore/grupodv/blob/main/paste/Imagem%20do%20WhatsApp%20de%202025-09-08%20%C3%A0(s)%2011.54.12_884bebc9.jpg?raw=true" alt="">
          <strong style="font-size:13px">Leonardo</strong>
        </button>
        <div class="user-menu">
          <a href="perfil.html">üë§ Meu Perfil</a>
          <button onclick="handleLogout()">üö™ Sair</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div id="painel"></div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-card">
      <div class="modal-h">
        <h3 id="modalTitle">Detalhes</h3>
        <span id="closeModal" class="close">‚úï</span>
      </div>
      <table>
        <thead><tr><th>Cantor</th><th>Pagamento</th></tr></thead>
        <tbody id="modalTable"></tbody>
      </table>
      <p id="modalCouvert" style="margin-top:14px;font-weight:700"></p>
      <p id="modalResultado" style="margin-top:6px"></p>
    </div>
  </div>

<script>
const API_AGENDA = "https://script.google.com/macros/s/AKfycbxJwRXw2lr2kK58EoHv-oUagd2FV2hvTHXRDJ5mFcNo5eZp3QlX7wX2KdrujAE5zPU-/exec";
const API_COUVERT = "https://script.google.com/macros/s/AKfycbxxv-9kLzyqS9Qy8WX_qPp7UG8He3OaEbIxZMV3HoRaSpdBfRYqZZZODLQlIJZDufso/exec";

let dadosAgenda=[], dadosCouvert=[];
const painel=document.getElementById("painel");
const modal=document.getElementById("modal"), modalTitle=document.getElementById("modalTitle"),
      modalTable=document.getElementById("modalTable"), modalCouvert=document.getElementById("modalCouvert"),
      modalResultado=document.getElementById("modalResultado");

const BRL=n=>(Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fmtData=d=>new Date(d).toLocaleDateString('pt-BR');

function handleLogout(){localStorage.removeItem("dv_pwd");location.reload();}
document.getElementById("themeToggle").addEventListener("click",()=>{
  const cur=document.documentElement.getAttribute("data-theme")||"light";
  const next=(cur==="light")?"dark":"light";
  document.documentElement.setAttribute("data-theme",next);
  localStorage.setItem("dv_theme",next);
});
const user=document.getElementById("userMenu");
user.querySelector(".user-btn").addEventListener("click",()=>user.classList.toggle("open"));
window.addEventListener("click",e=>{if(!user.contains(e.target))user.classList.remove("open");});

async function carregar(){
  painel.innerHTML="<p>Carregando...</p>";
  try{
    const [r1,r2] = await Promise.all([fetch(API_AGENDA), fetch(API_COUVERT)]);
    dadosAgenda = await r1.json();
    dadosCouvert = await r2.json();
    render();
  }catch(e){
    console.error(e);
    painel.innerHTML="<p>Erro ao carregar dados</p>";
  }
}

function render(){
  painel.innerHTML="";
  const grupos={};
  dadosAgenda.forEach(ev=>{
    const key=ev.empresa+"|"+ev.data.split("T")[0];
    if(!grupos[key]) grupos[key]={empresa:ev.empresa,data:ev.data.split("T")[0],pagamentos:[],totalPago:0};
    grupos[key].pagamentos.push({cantor:ev.cantor,valor:+ev.valor||0});
    grupos[key].totalPago+=+ev.valor||0;
  });

  const couvertMap={};
  (dadosCouvert.registros||[]).forEach(c=>{
    const key=c.empresa+"|"+c.data;
    couvertMap[key]=+c.total_dia||0;
  });

  Object.values(grupos).forEach(gr=>{
    const couvert=couvertMap[gr.empresa+"|"+gr.data]||0;
    const resultado=couvert-gr.totalPago;
    const card=document.createElement("div");
    card.className="card "+(resultado>=0?"lucro":"prejuizo");
    card.innerHTML=`
      <h2>${gr.empresa} ‚Äì ${fmtData(gr.data)}</h2>
      <p>üé§ Pago m√∫sicos: <b>${BRL(gr.totalPago)}</b></p>
      <p>üéüÔ∏è Couvert: <b>${BRL(couvert)}</b></p>
      <p>${resultado>=0?"‚úÖ Lucro":"‚ùå Preju√≠zo"}: <b>${BRL(resultado)}</b></p>
    `;
    card.onclick=()=>abrirModal(gr, couvert, resultado);
    painel.appendChild(card);
  });
}

function abrirModal(gr, couvert, resultado){
  modalTitle.textContent=`${gr.empresa} ‚Äì ${fmtData(gr.data)}`;
  modalTable.innerHTML=gr.pagamentos.map(p=>`<tr><td>${p.cantor}</td><td>${BRL(p.valor)}</td></tr>`).join("");
  modalCouvert.textContent="üéüÔ∏è Couvert arrecadado: "+BRL(couvert);
  modalResultado.textContent=(resultado>=0?"‚úÖ Lucro: ":"‚ùå Preju√≠zo: ")+BRL(resultado);
  modalResultado.style.color=resultado>=0?"var(--ok)":"var(--bad)";
  modal.classList.add("open");
}
document.querySelector(".close").onclick=()=>modal.classList.remove("open");

carregar();
</script>
</body>
</html>
