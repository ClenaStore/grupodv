<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Agenda de M√∫sicos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Great+Vibes&family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root{
      --amarelo:#ffd700; --overlay:rgba(10,0,30,.78);
      --texto:#fff; --muted:#d8d8d8; --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.18);
    }
    body{margin:0;font-family:'Poppins',sans-serif;background:#0b0b15;color:var(--texto);}
    header.titulo{position:sticky;top:0;background:var(--overlay);
      display:flex;justify-content:space-between;align-items:center;
      padding:16px 20px;z-index:100;}
    .title{margin:0;font-family:'Bebas Neue',sans-serif;font-size:32px;color:var(--amarelo);}
    .head-right{display:flex;align-items:center;gap:12px}
    select,button{padding:8px 10px;border-radius:8px;border:1px solid var(--line);font-size:15px;}
    button{cursor:pointer;background:var(--amarelo);font-weight:600}
    .content{padding:20px;max-width:960px;margin:auto;}
    .grupo{display:grid;grid-template-columns:80px 1fr;gap:12px;margin-bottom:16px;}
    .dia{font-family:'Bebas Neue',sans-serif;font-size:30px;color:#fff;text-align:center}
    .dia small{display:block;color:var(--amarelo);font-size:12px;}
    .itens{border-left:4px solid var(--amarelo);padding-left:12px;display:flex;flex-direction:column;gap:10px;}
    .linha{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px 16px;
      display:flex;justify-content:space-between;cursor:pointer;transition:.2s;}
    .linha:hover{background:rgba(255,215,0,0.08);}
    .linha .texto{font-weight:600;}
    .linha .hora{color:var(--muted);font-weight:600;}
    #modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:2000;}
    .modal-box{background:#101326;color:#fff;padding:20px;border-radius:14px;width:min(400px,92%);}
    .modal-box h3{margin:0 0 10px;font-size:18px;}
    .kv{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.15);}
    .kv:last-child{border-bottom:none;}
    .kv b{color:var(--amarelo);}
    .btn-close{margin-top:14px;width:100%;padding:10px;background:var(--amarelo);border:none;border-radius:10px;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <header class="titulo">
    <h1 class="title">Agenda</h1>
    <div class="head-right">
      <select id="empresaSel">
        <option value="">Selecione a empresa</option>
        <option>Mercatto Del√≠cia</option>
        <option>Villa Gourmet</option>
        <option>Del√≠cia Gourmet</option>
      </select>
      <button id="calendarBtn">üìÖ Filtro</button>
    </div>
  </header>

  <div class="content"><main class="lista" id="lista"></main></div>

  <!-- Modal detalhes -->
  <div id="modal"><div class="modal-box">
    <h3>Detalhes</h3>
    <div class="kv"><span>Data</span><b id="m_data"></b></div>
    <div class="kv"><span>Cantor</span><b id="m_cantor"></b></div>
    <div class="kv"><span>Hor√°rio</span><b id="m_hora"></b></div>
    <div class="kv"><span>Valor</span><b id="m_valor"></b></div>
    <button class="btn-close" onclick="fecharModal()">Fechar</button>
  </div></div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <script>
    const API_URL="https://script.google.com/macros/s/AKfycbzCWTJPkUHvHdvQrvWOu-jbd_I2O7VAnL8cDRrWuXACy4xWifwfIYd48MWiksmNpORm/exec";
    let EMPRESA=null,filtroDe=null,filtroAte=null;

    const pad=n=>String(n).padStart(2,'0');
    const safeDateKey=i=>{if(!i)return null;const d=new Date(i);return isNaN(d)?null:`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
    const safeTime=t=>t?String(t).substring(0,5):"--:--";
    const brMoney=v=>Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    const calendar=flatpickr("#calendarBtn",{mode:"range",dateFormat:"d/m/Y",locale:"pt",
      onClose:(d)=>{filtroDe=d[0]||null;filtroAte=d[1]||null;carregarAgenda();}
    });

    document.getElementById('empresaSel').addEventListener('change',()=>{
      EMPRESA=document.getElementById('empresaSel').value;
      if(EMPRESA) carregarAgenda();
    });

    async function carregarAgenda(){
      const box=document.getElementById('lista'); box.innerHTML="";
      if(!EMPRESA){box.innerHTML="<p>Selecione uma empresa.</p>";return;}
      let eventos=[];
      try{
        const rsp=await fetch(`${API_URL}?empresa=${encodeURIComponent(EMPRESA)}`);
        eventos=await rsp.json();
      }catch(e){box.innerHTML="<p>Erro ao carregar.</p>";return;}

      if(filtroDe&&filtroAte){
        const from=safeDateKey(filtroDe),to=safeDateKey(filtroAte);
        eventos=eventos.filter(ev=>{const k=safeDateKey(ev.data);return k&&k>=from&&k<=to;});
      }

      const grupos={}; for(const ev of eventos){const k=safeDateKey(ev.data); if(k)(grupos[k] ||= []).push(ev);}
      const dias=Object.keys(grupos).sort();
      if(!dias.length){box.innerHTML="<p>Sem eventos no per√≠odo.</p>";return;}

      for(const k of dias){
        const [y,m,d]=k.split('-').map(Number);
        const dia=pad(d),mes=new Date(y,m-1,d).toLocaleString('pt-BR',{month:'short'}).toUpperCase();
        const itens=grupos[k].map(ev=>`
          <div class="linha" onclick="abrirModal('${k}','${ev.cantor}','${ev.hora}','${ev.valor}')">
            <div class="texto">${ev.cantor}</div>
            <div class="hora">${safeTime(ev.hora)}</div>
          </div>`).join("");
        box.innerHTML+=`<section class="grupo"><div class="dia">${dia}<small>${mes}</small></div><div class="itens">${itens}</div></section>`;
      }
    }

    function abrirModal(data,cantor,hora,valor){
      const dt=new Date(`${data}T00:00:00`);
      document.getElementById('m_data').textContent=dt.toLocaleDateString('pt-BR',{weekday:'short',day:'2-digit',month:'short'});
      document.getElementById('m_cantor').textContent=cantor;
      document.getElementById('m_hora').textContent=safeTime(hora);
      document.getElementById('m_valor').textContent=brMoney(valor);
      document.getElementById('modal').style.display="flex";
    }
    function fecharModal(){document.getElementById('modal').style.display="none";}
  </script>
</body>
</html>
