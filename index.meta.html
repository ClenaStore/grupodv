<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Metas de Receita - Grupo DV</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #0b1020;
      --surface: #10172a;
      --card: #0f172a;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --line: rgba(148,163,184,.25);
      --brand: #60a5fa;
      --brand-2: #22d3ee;
      --shadow: 0 20px 60px rgba(2,6,23,.35);
    }
    [data-theme="light"] {
      --bg: #f6f7fb;
      --surface: #fff;
      --card: #fff;
      --text: #0f172a;
      --muted: #475569;
      --line: #e5e7eb;
      --shadow: 0 16px 36px rgba(15,23,42,.08);
    }

    body {
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--line);
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    header img { height: 46px; }
    header h1 { flex: 1; text-align: center; font-size: 1.4em; font-weight: 800; }

    .container { padding: 20px; max-width: 1200px; margin: auto; }

    .filters {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 20px;
      align-items: end;
    }
    .filters label {
      font-weight: 700; color: var(--muted); font-size: .95em; margin-bottom: 6px;
      display: block;
    }
    .filters select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: var(--surface);
      color: var(--text);
      width: 100%;
    }
    .date-btn {
      border: 1px solid var(--line);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text);
      padding: 10px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
    }
    .range-label { font-weight: 600; font-size: .9em; color: var(--muted); }

    .filters button, #btnWhats {
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      border: 1px solid var(--line);
    }
    .filters button { background: var(--surface); color: var(--text); }
    #btnWhats { background: #25d366; color: white; margin: 10px 0; }

    .metas-box {
      background: var(--card);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }
    .metas-box h2 { margin: 0 0 10px; font-size: 1.1em; font-weight: 800; }
    .metas-box p { margin: 4px 0; font-size: .95em; }

    .chart-box {
      background: var(--card);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 20px;
    }

    /* Loading overlay */
    #loading {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      color: #fff;
      font-weight: 800;
      flex-direction: column;
    }
    #loading.show { display: flex; }
    .spinner {
      width: 42px; height: 42px; border: 4px solid rgba(255,255,255,.25);
      border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .filters { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo">
  <h1>ðŸ“Š Painel de Metas</h1>
</header>

<div class="container">
  <div class="filters">
    <div style="grid-column: span 2;">
      <label>PerÃ­odo:</label>
      <button id="btnRange" class="date-btn">ðŸ“… Selecionar</button>
      <span id="rangeLabel" class="range-label">â€”</span>
      <input type="hidden" id="dataInicio">
      <input type="hidden" id="dataFim">
    </div>
    <div>
      <label>Empresa:</label>
      <select id="empresaFiltro"><option value="">Todas</option></select>
    </div>
    <div>
      <button id="btnFiltrar">Filtrar</button>
    </div>
  </div>

  <button id="btnWhats">ðŸ“² Enviar via WhatsApp</button>
  <div id="painelMetas"></div>

  <div class="chart-box" id="graficoContainer" style="display:none;">
    <h3>ðŸ“ˆ EvoluÃ§Ã£o do Faturamento</h3>
    <canvas id="graficoFaturamento"></canvas>
  </div>
</div>

<!-- Loading overlay -->
<div id="loading"><div class="spinner"></div><div id="loadingText">Carregandoâ€¦</div></div>

<script>
const urlBase = '/api/meta';
let chart;

// Utils
const $ = s=>document.querySelector(s);
const pad2 = n=> String(n).padStart(2,'0');
const toISO = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const toBR = d => `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
const fmtRangeBR = (a,b)=> `${toBR(a)} â†’ ${toBR(b)}`;

function showLoading(txt){ $("#loadingText").textContent = txt||"Carregandoâ€¦"; $("#loading").classList.add('show'); }
function hideLoading(){ $("#loading").classList.remove('show'); }

function formatarNumero(v){ return parseFloat(v).toLocaleString('pt-BR',{minimumFractionDigits:2}); }
function formatarDataBR(dataISO){ const [y,m,d] = dataISO.split("-"); return `${d}/${m}/${y}`; }

// CalendÃ¡rio rÃ¡pido (igual ao do Couvert)
function selecionarOntem(){
  const hoje = new Date();
  const ontem = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()-1);
  $("#dataInicio").value = toISO(ontem);
  $("#dataFim").value = toISO(ontem);
  $("#rangeLabel").textContent = fmtRangeBR(ontem,ontem);
}

async function carregarMetas(){
  showLoading("Carregando metasâ€¦");
  const painel = $("#painelMetas");
  painel.innerHTML = "";

  const params = new URLSearchParams();
  if($("#dataInicio").value) params.append("dataInicio", $("#dataInicio").value);
  if($("#dataFim").value) params.append("dataFim", $("#dataFim").value);
  if($("#empresaFiltro").value) params.append("empresa", $("#empresaFiltro").value);

  try{
    const r = await fetch(`${urlBase}?${params.toString()}`);
    const metas = await r.json();

    // Preenche empresas
    const empresas = [...new Set(metas.map(m=>m.Empresa))];
    const sel = $("#empresaFiltro");
    if(sel.options.length<=1){
      empresas.forEach(e=>{
        const opt=document.createElement("option");
        opt.value=e; opt.textContent=e;
        sel.appendChild(opt);
      });
    }

    if(metas.length===0){
      painel.innerHTML="<p style='text-align:center;color:var(--muted)'>Nenhum dado encontrado.</p>";
      $("#graficoContainer").style.display="none";
      hideLoading();
      return;
    }

    metas.forEach(linha=>{
      const previsto = parseFloat(linha["Previsto"]);
      const realizado = parseFloat(linha["Realizado"].toString().replace(",","."))||0;
      const atingido = previsto>0 ? (realizado/previsto)*100 : 0;

      const div=document.createElement("div");
      div.className="metas-box";
      div.innerHTML=`
        <h2>${linha.Empresa}</h2>
        <p>ðŸ’° Previsto: R$ ${formatarNumero(previsto)}</p>
        <p>âœ… Realizado: R$ ${formatarNumero(realizado)}</p>
        <p>ðŸ“Š Atingido: ${formatarNumero(atingido)}%</p>`;
      painel.appendChild(div);
    });

    if($("#empresaFiltro").value){
      mostrarGrafico(metas);
      $("#graficoContainer").style.display="block";
    }else{
      $("#graficoContainer").style.display="none";
    }
  }catch(e){
    painel.innerHTML="Erro ao carregar.";
  }
  hideLoading();
}

function mostrarGrafico(metas){
  const ctx=$("#graficoFaturamento").getContext("2d");
  metas.sort((a,b)=> new Date(a.Data)-new Date(b.Data));
  const dias=metas.map(m=>m.Data.split("-").reverse().join("/"));
  const valores=metas.map(m=> parseFloat(m.Realizado.toString().replace(",",".")));

  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'line',
    data:{ labels:dias, datasets:[{
      label:"EvoluÃ§Ã£o do Faturamento",
      data:valores, fill:true,
      borderColor:"#388e3c",
      backgroundColor:"rgba(56,142,60,0.1)",
      tension:0.3, pointRadius:6, pointHoverRadius:10, pointHitRadius:28
    }]},
    options:{ responsive:true, interaction:{mode:'nearest',intersect:false} }
  });
}

// WhatsApp
$("#btnWhats").addEventListener("click",()=>{
  const di=$("#dataInicio").value, df=$("#dataFim").value;
  const periodo=(di&&df)? `${formatarDataBR(di)} - ${formatarDataBR(df)}`:"PerÃ­odo nÃ£o informado";
  const blocos=document.querySelectorAll(".metas-box");
  if(!blocos.length) return alert("Nada para enviar.");

  let msg=`ðŸ“† Resumo da meta de receitas ${periodo}\n\n`;
  blocos.forEach(b=>{
    msg+=`*${b.querySelector("h2").innerText}*\n${[...b.querySelectorAll("p")].map(p=>p.innerText).join("\n")}\n\n`;
  });
  window.open(`https://wa.me/5577999761436?text=${encodeURIComponent(msg)}`,"_blank");
});

// Inicializa
window.onload=()=>{ selecionarOntem(); carregarMetas(); };
$("#btnFiltrar").onclick=carregarMetas;
</script>
</body>
</html>
