<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Metas de Receita - Grupo DV</title>

  <style>
    :root{
      /* Tema escuro (padr√£o) ‚Äî igual ao index */
      --bg:#0b1020; --surface:#10172a; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --line:rgba(148,163,184,.25); --brand:#60a5fa; --brand2:#22d3ee; --shadow:0 20px 60px rgba(2,6,23,.35);
      --icon-bg:rgba(255,255,255,.06); --grad:linear-gradient(135deg,var(--brand),var(--brand2));
      --ring:rgba(99,102,241,.35);
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --surface:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --line:#e5e7eb; --icon-bg:rgba(2,6,23,.06); --shadow:0 16px 36px rgba(15,23,42,.08);
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family:ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg); color:var(--text); overflow-x:hidden; font-size:14px;
    }

    /* ===== Header unificado ===== */
    header{
      position:sticky; top:0; z-index:50; backdrop-filter:saturate(160%) blur(8px);
      background: color-mix(in srgb, var(--surface) 80%, transparent);
      border-bottom:1px solid var(--line);
    }
    .head-wrap{
      max-width:100%; /* tela cheia no desktop */
      margin:0 auto; padding:14px 18px; display:flex; align-items:center; gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit }
    .brand img{ height:42px }
    .title{ font-weight:800; letter-spacing:.2px; font-size:clamp(18px,1.6vw,22px) }
    .head-spacer{ flex:1 }
    .icon-btn{
      border:1px solid var(--line); background:var(--surface); color:var(--text);
      padding:10px 12px; border-radius:12px; font-weight:800; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px; text-decoration:none;
      transition:.2s transform, .2s box-shadow;
    }
    .icon-btn:hover{ transform:translateY(-2px); box-shadow:var(--shadow) }
    .only-desktop{ display:inline-flex }
    @media (max-width:900px){ .only-desktop{ display:none !important } }

    .user{ position:relative }
    .user-btn{
      display:flex; align-items:center; gap:10px; cursor:pointer;
      border:1px solid var(--line); background:var(--surface); padding:6px 8px; border-radius:999px;
    }
    .user-btn img{ width:34px; height:34px; border-radius:50%; object-fit:cover; background:var(--icon-bg) }
    .user-menu{
      position:absolute; right:0; top:110%; background:var(--surface); border:1px solid var(--line);
      border-radius:12px; box-shadow:var(--shadow); min-width:200px; padding:6px; display:none;
    }
    .user.open .user-menu{ display:block }
    .user-menu a,.user-menu button{
      display:flex; width:100%; background:transparent; color:var(--text); border:none;
      text-align:left; padding:10px 12px; border-radius:10px; cursor:pointer; text-decoration:none; font-weight:600;
    }
    .user-menu a:hover,.user-menu button:hover{ background:var(--icon-bg) }

    /* ===== √Årea de filtros + cards ===== */
    .container{
      max-width:100%; /* tela cheia no desktop */
      margin:0 auto; padding:18px;
    }

    .filters{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:12px;
    }
    .btn{
      border:1px solid var(--line); background:var(--surface); color:var(--text);
      padding:10px 12px; border-radius:12px; font-weight:800; cursor:pointer;
    }
    .btn.dark{ background:#111827; color:#fff; border-color:#111827 }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .muted{ color:var(--muted) }

    .pill{ border:1px solid var(--line); border-radius:999px; padding:8px 12px; background:var(--surface); font-weight:800 }

    .cards{
      display:grid; gap:12px;
      grid-template-columns: repeat(12, minmax(0, 1fr));
    }
    .meta-card{
      grid-column: span 3 / span 3;
      background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:var(--shadow);
    }
    .meta-card h3{ margin:0 0 6px; font-size:16px }
    .meta-card .row{ display:grid; grid-template-columns: 1fr auto; gap:8px; margin:6px 0 }
    .meta-card .label{ color:var(--muted) }
    .badge{
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--line);
      font-size:12px; color:var(--muted);
    }
    .kpi{ font-weight:800 }

    @media (max-width:1160px){ .meta-card{ grid-column: span 4 / span 4 } }
    @media (max-width:760px){ .meta-card{ grid-column: span 12 / span 12 } }

    /* ===== Popover calend√°rio ===== */
    .overlay{ position:fixed; inset:0; background:transparent; display:none; z-index:40 }
    .popover{
      position:fixed; z-index:50; display:none; background:var(--surface);
      border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow);
      padding:10px; width:min(94vw,360px); max-height:80vh; overflow:auto;
    }
    .cal .cal-head{ display:flex; align-items:center; justify-content:space-between; padding:6px 8px }
    .cal .title{ font-weight:800 }
    .cal .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; padding:8px }
    .cal .dow{ text-align:center; color:var(--muted); font-size:12px }
    .cal .day{
      height:34px; border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer;
      border:1px solid transparent; font-weight:700; user-select:none;
    }
    .cal .day:hover{ background: color-mix(in srgb, var(--surface) 85%, #fff) }
    .cal .day.out{ opacity:.35 }
    .cal .day.sel{ background: var(--brand); color:#fff }
    .cal .day.range{ background: color-mix(in srgb, var(--brand) 20%, transparent); }
    .cal .foot{ display:flex; justify-content:flex-end; gap:8px; padding:8px }

    /* ===== Loading overlay ===== */
    #loading{
      position:fixed; inset:0; background:rgba(2,6,23,.45); display:none; z-index:70;
      align-items:center; justify-content:center; color:#fff; font-weight:900; letter-spacing:.5px;
    }
    #loading .box{
      background:rgba(17,24,39,.9); padding:14px 16px; border:1px solid rgba(255,255,255,.1);
      border-radius:12px; box-shadow:var(--shadow);
    }
  </style>

  <!-- Prote√ß√£o por senha + tema sincronizado + interceptador fetch -->
  <script>
  (function(){
    const KEY_NAME='dv_pwd';
    const savedTheme = localStorage.getItem('dv_theme');
    if(savedTheme){ document.documentElement.setAttribute('data-theme', savedTheme); }

    window.__toggleTheme = function(){
      const cur = document.documentElement.getAttribute('data-theme') || 'light';
      const next = (cur==='light')?'dark':'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('dv_theme', next);
    };

    async function ensurePassword(){
      let pwd = localStorage.getItem(KEY_NAME) || '';
      while(!pwd){
        pwd = prompt('Digite a senha de acesso:') || '';
        if(!pwd) continue;
        try{
          const r = await fetch('/api/ping', { headers:{'x-api-key': pwd} });
          if(r.ok){ localStorage.setItem(KEY_NAME, pwd); break; }
          else { alert('Senha incorreta.'); pwd=''; }
        }catch(e){
          localStorage.setItem(KEY_NAME, pwd); break;
        }
      }
    }

    const _fetch = window.fetch.bind(window);
    window.fetch = (input, init={})=>{
      let url = (typeof input === 'string') ? input : (input && input.url) || '';
      init = init || {};
      const headers = new Headers(init.headers || ((typeof input!=='string' && input.headers) || {}));
      const pwd = localStorage.getItem(KEY_NAME) || '';
      if(url.startsWith('/api/') && pwd){ headers.set('x-api-key', pwd); }
      return _fetch(input, Object.assign({}, init, { headers }));
    };

    if(!localStorage.getItem(KEY_NAME)){ ensurePassword(); }
    window.__DV_PWD_KEY__ = KEY_NAME;
  })();
  </script>
</head>
<body>

  <!-- Loading -->
  <div id="loading"><div class="box">‚è≥ Carregando‚Ä¶</div></div>

  <!-- Header -->
  <header>
    <div class="head-wrap">
      <a class="brand" href="index.html" aria-label="In√≠cio">
        <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo">
        <div class="title">Metas de Receita</div>
      </a>
      <div class="head-spacer"></div>

      <a class="icon-btn only-desktop" href="index.relatorios.html" title="Relat√≥rio Consolidado">üìÑ Relat√≥rios</a>
      <button id="themeToggle" class="icon-btn" type="button" title="Alternar tema">üåì Tema</button>

      <div class="user" id="userMenu">
        <button class="user-btn" type="button" title="Perfil">
          <img src="https://github.com/ClenaStore/grupodv/blob/main/paste/Imagem%20do%20WhatsApp%20de%202025-09-08%20%C3%A0(s)%2011.54.12_884bebc9.jpg?raw=true" alt="Usu√°rio">
          <strong style="font-size:13px">Leonardo</strong>
        </button>
        <div class="user-menu">
          <a href="perfil.html">üë§ Meu Perfil</a>
          <button onclick="handleLogout()">üö™ Sair</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Filtros -->
    <div class="filters">
      <button id="btnPeriodo" class="btn"><span>Per√≠odo:</span> <span id="lblPeriodo" class="pill">‚Äî</span></button>
      <button id="btnUlt7" class="btn">‚Ü∫ √öltimos 7 dias</button>

      <label class="muted" style="font-weight:800">Empresa:</label>
      <select id="empresaFiltro" class="btn" style="min-width:220px"></select>

      <button id="btnAplicar" class="btn dark">Aplicar</button>
    </div>

    <!-- Cards -->
    <div class="cards" id="cards"></div>
  </div>

  <!-- Popover calend√°rio -->
  <div class="overlay" id="overlay"></div>
  <div class="popover" id="popPeriodo"></div>

  <script>
  /* ===== Tema & usu√°rio ===== */
  document.getElementById('themeToggle')?.addEventListener('click', ()=> window.__toggleTheme && window.__toggleTheme());
  const user = document.getElementById('userMenu');
  user.querySelector('.user-btn').addEventListener('click', ()=> user.classList.toggle('open'));
  window.addEventListener('click', (e)=>{ if(!user.contains(e.target)) user.classList.remove('open'); });
  function handleLogout(){ try{ localStorage.removeItem('dv_pwd'); }catch(e){} location.reload(); }
  window.handleLogout = handleLogout;

  /* ===== Utils ===== */
  const $ = s=>document.querySelector(s);
  const BRL = n => (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const pad2 = n => String(n).padStart(2,'0');
  const toISO = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseISO = s => { const [y,m,d]=String(s).split('-').map(Number); return new Date(y, (m||1)-1, d||1); };
  const diffDaysInc = (a,b)=> Math.floor((b - a)/(24*3600*1000)) + 1;
  const daysInMonth = (y,m)=> new Date(y,m+1,0).getDate(); // m: 0-11

  /* ===== Estado ===== */
  const API = '/api/meta';
  let dados = [];                  // registros brutos
  let rangeIni, rangeFim;          // datas (Date)
  let empresaSel = '';             // filtro empresa

  /* ===== Calend√°rio / Popover ===== */
  const pop = $('#popPeriodo'), overlay = $('#overlay');
  let calState = { cursor: new Date(), start: null, end: null };

  function openPopover(){
    buildCalendar(pop, calState, (start,end)=>{
      rangeIni = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      rangeFim = new Date(end.getFullYear(), end.getMonth(), end.getDate());
      updatePeriodoLabel();
      closePopover();
    }, closePopover);
    placePopover(pop, $('#btnPeriodo'));
  }
  function closePopover(){ pop.style.display='none'; overlay.style.display='none'; }
  function placePopover(popover, anchor){
    popover.style.display='block'; overlay.style.display='block';
    const r = anchor.getBoundingClientRect(); const PAD=8; const w = Math.min(window.innerWidth*0.94, 360);
    popover.style.width = w+'px';
    let left = r.left, top = r.bottom + 6;
    if(left + w > window.innerWidth - PAD) left = window.innerWidth - w - PAD;
    if(left < PAD) left = PAD;
    popover.style.position='fixed'; popover.style.left = left+'px'; popover.style.top = top+'px';
  }
  overlay.addEventListener('click', closePopover);

  function buildCalendar(container, state, onApply, onCancel){
    container.innerHTML='';
    const root = document.createElement('div'); root.className='cal';
    const head = document.createElement('div'); head.className='cal-head';

    const prev = document.createElement('button'); prev.className='btn'; prev.textContent='‚Äπ';
    const next = document.createElement('button'); next.className='btn'; next.textContent='‚Ä∫';
    const title = document.createElement('div'); title.className='title';

    const updTitle = ()=> title.textContent = state.cursor.toLocaleString('pt-BR',{month:'long',year:'numeric'});
    prev.onclick = ()=>{ state.cursor = new Date(state.cursor.getFullYear(), state.cursor.getMonth()-1, 1); drawGrid(); updTitle(); placePopover(container, $('#btnPeriodo')); };
    next.onclick = ()=>{ state.cursor = new Date(state.cursor.getFullYear(), state.cursor.getMonth()+1, 1); drawGrid(); updTitle(); placePopover(container, $('#btnPeriodo')); };

    head.appendChild(prev); head.appendChild(title); head.appendChild(next);
    root.appendChild(head);

    const grid = document.createElement('div'); grid.className='grid';
    "DSTQQSS".split('').forEach(l=>{ const d=document.createElement('div'); d.className='dow'; d.textContent=l; grid.appendChild(d); });

    function sameYMD(a,b){ return a&&b && a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
    function inSel(d){
      if(!state.start || !state.end) return false;
      const dd = new Date(d.getFullYear(),d.getMonth(),d.getDate());
      const s = new Date(state.start.getFullYear(),state.start.getMonth(),state.start.getDate());
      const e = new Date(state.end.getFullYear(),state.end.getMonth(),state.end.getDate());
      return dd>=s && dd<=e;
    }

    function drawGrid(){
      grid.querySelectorAll('.day').forEach(n=>n.remove());
      const y=state.cursor.getFullYear(), m=state.cursor.getMonth();
      const first=new Date(y,m,1); const startDay=(first.getDay()+6)%7; const days=new Date(y,m+1,0).getDate();
      for(let i=0;i<startDay;i++){ const x=document.createElement('div'); x.className='day out'; grid.appendChild(x); }
      for(let d=1; d<=days; d++){
        const date=new Date(y,m,d);
        const el=document.createElement('div'); el.className='day'; el.textContent=d;
        if(sameYMD(date,state.start)||sameYMD(date,state.end)) el.classList.add('sel');
        else if(inSel(date)) el.classList.add('range');
        el.onclick = ()=>{
          if(!state.start || (state.start && state.end)){ state.start=date; state.end=null; }
          else{
            if(date < state.start){ state.end = state.start; state.start = date; }
            else { state.end = date; }
          }
          drawGrid();
        };
        grid.appendChild(el);
      }
    }
    root.appendChild(grid);

    const foot = document.createElement('div'); foot.className='cal foot';
    const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancelar';
    const apply = document.createElement('button'); apply.className='btn dark'; apply.textContent='Aplicar';
    cancel.onclick = onCancel;
    apply.onclick = ()=>{ if(state.start && !state.end) state.end = state.start; if(state.start && state.end) onApply(state.start, state.end); };
    foot.appendChild(cancel); foot.appendChild(apply);
    root.appendChild(foot);

    container.appendChild(root);
    updTitle(); drawGrid();
  }

  /* ===== P√°gina (dados + c√°lculo) ===== */
  const cards = $('#cards');
  const selEmpresa = $('#empresaFiltro');

  function setLoading(on){ $('#loading').style.display = on ? 'flex' : 'none'; }

  function updatePeriodoLabel(){
    $('#lblPeriodo').textContent = `${fmtBR(rangeIni)} ‚Üí ${fmtBR(rangeFim)}`;
    // atualiza calend√°rio para m√™s da data inicial
    calState = { cursor: new Date(rangeIni.getFullYear(), rangeIni.getMonth(), 1), start: rangeIni, end: rangeFim };
  }
  function fmtBR(d){ return d.toLocaleDateString('pt-BR'); }

  function setUltimos7(){
    const hoje = new Date(); const fim = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()-1);
    const ini = new Date(fim.getFullYear(), fim.getMonth(), fim.getDate()-6);
    rangeIni = ini; rangeFim = fim; updatePeriodoLabel();
  }

  async function carregar(){
    setLoading(true);
    try{
      // Busca inicial
      const r = await fetch(API);
      dados = await r.json();
      // Empresas no select
      const empresas = [...new Set(dados.map(x=>x.Empresa))].sort();
      selEmpresa.innerHTML = `<option value="">Todas</option>` + empresas.map(e=>`<option>${e}</option>`).join('');
      // Default per√≠odo: √∫ltimos 7 dias
      setUltimos7();
      render();
    }catch(e){
      console.error(e);
      cards.innerHTML = `<div class="meta-card" style="grid-column:1/-1"><h3>N√£o foi poss√≠vel carregar os dados agora.</h3></div>`;
    }finally{
      setLoading(false);
    }
  }

  function aplicar(){
    setLoading(true);
    setTimeout(()=>{ render(); setLoading(false); }, 30);
  }

  function render(){
    empresaSel = selEmpresa.value || '';
    // filtra por range
    const iniISO = toISO(rangeIni), fimISO = toISO(rangeFim);
    const porEmpresa = new Map(); // emp -> registros ordenados por data (dentro do range)
    dados.forEach(row=>{
      const emp = row.Empresa || '';
      const data = String(row.Data||'');
      if(data >= iniISO && data <= fimISO){
        if(empresaSel && emp !== empresaSel) return;
        if(!porEmpresa.has(emp)) porEmpresa.set(emp, []);
        porEmpresa.get(emp).push(row);
      }
    });

    // monta cards
    const itens = [];
    porEmpresa.forEach((lista, emp)=>{
      lista.sort((a,b)=> new Date(a.Data) - new Date(b.Data));
      const first = lista[0], last = lista[lista.length-1];

      // campos
      const prev   = parseFloat(String(last?.Previsto??first?.Previsto??0).toString().replace(',', '.')) || 0;
      const rFirst = parseFloat(String(first?.Realizado??0).toString().replace(',', '.')) || 0;
      const rLast  = parseFloat(String(last?.Realizado??0).toString().replace(',', '.')) || 0;

      // Resultado do per√≠odo = √∫ltimo - primeiro (exatamente como voc√™ pediu)
      const resultado = rLast - rFirst;

      const diasPeriodo = Math.max(1, diffDaysInc(rangeIni, rangeFim)); // inclusivo
      const mediaDia = resultado / diasPeriodo;

      // dias do m√™s da data final
      const y = rangeFim.getFullYear(), m = rangeFim.getMonth();
      const diasMes = daysInMonth(y, m);
      const previsaoMes = mediaDia * diasMes;

      const percMeta = prev > 0 ? (resultado/prev)*100 : 0;

      itens.push({
        emp, prev, resultado, percMeta, mediaDia, previsaoMes
      });
    });

    // ordena por maior resultado desc
    itens.sort((a,b)=> b.resultado - a.resultado);

    // render
    if(itens.length === 0){
      cards.innerHTML = `<div class="meta-card" style="grid-column:1/-1"><h3>Nenhum dado no per√≠odo.</h3></div>`;
      return;
    }
    cards.innerHTML = itens.map(x=>cardHTML(x)).join('');
  }

  function cardHTML(x){
    return `
      <div class="meta-card">
        <div class="badge">Empresa</div>
        <h3>${x.emp}</h3>

        <div class="row">
          <div class="label">Resultado no per√≠odo</div>
          <div class="kpi">${BRL(x.resultado)}</div>
        </div>

        <div class="row">
          <div class="label">% da meta (Previsto)</div>
          <div class="kpi">${(x.percMeta||0).toLocaleString('pt-BR',{maximumFractionDigits:2})}%</div>
        </div>

        <div class="row">
          <div class="label">M√©dia por dia</div>
          <div class="kpi">${BRL(x.mediaDia)}</div>
        </div>

        <div class="row">
          <div class="label">Previs√£o do m√™s</div>
          <div class="kpi">${BRL(x.previsaoMes)}</div>
        </div>

        <div class="row">
          <div class="label">Meta mensal (Previsto)</div>
          <div class="kpi">${BRL(x.prev)}</div>
        </div>
      </div>
    `;
  }

  /* ===== Eventos ===== */
  $('#btnPeriodo').addEventListener('click', openPopover);
  $('#btnUlt7').addEventListener('click', ()=>{ setUltimos7(); aplicar(); });
  $('#btnAplicar').addEventListener('click', aplicar);

  // inicia per√≠odo padr√£o (ontem e √∫ltimos 7) e carrega
  (function initPeriodo(){
    const hoje = new Date(); const fim = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()-1);
    const ini = new Date(fim.getFullYear(), fim.getMonth(), fim.getDate()-6);
    rangeIni=ini; rangeFim=fim;
    updatePeriodoLabel();
    // calend√°rio come√ßa no m√™s do in√≠cio
    calState = { cursor:new Date(rangeIni.getFullYear(), rangeIni.getMonth(), 1), start: rangeIni, end: rangeFim };
  })();
  carregar();
  </script>
</body>
</html>
