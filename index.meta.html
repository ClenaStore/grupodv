<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Metas de Receita - Grupo DV</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0b1020; --surface:#10172a; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
      --line:rgba(148,163,184,.25); --icon-bg:rgba(255,255,255,.06); --shadow:0 20px 60px rgba(2,6,23,.35);
      --brand:#60a5fa; --brand2:#22d3ee; --ok:#16a34a; --bad:#dc2626;
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --surface:#fff; --card:#fff; --text:#0f172a; --muted:#475569;
      --line:#e5e7eb; --icon-bg:rgba(2,6,23,.06); --shadow:0 16px 36px rgba(15,23,42,.08);
    }
    body{margin:0;font-family:ui-sans-serif,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    html,body{height:100%}

    header{position:sticky;top:0;z-index:40;backdrop-filter:blur(8px);
      background:color-mix(in srgb,var(--surface) 80%,transparent);border-bottom:1px solid var(--line)}
    .head{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;color:inherit;text-decoration:none}
    .brand img{height:42px}
    .title{font-weight:800;font-size:clamp(18px,1.6vw,22px)}
    .grow{flex:1}

    .container{max-width:100%;padding:20px 18px}
    .filters{display:grid;grid-template-columns:320px 220px 160px 140px 200px;gap:12px;align-items:end}
    @media(max-width:1100px){.filters{grid-template-columns:1fr 1fr}}
    @media(max-width:600px){.filters{grid-template-columns:1fr}}

    .field label{display:block;margin:0 0 6px;color:var(--muted);font-weight:800}
    .picker-btn, select{width:100%;border:1px solid var(--line);background:var(--surface);color:var(--text);border-radius:12px;padding:12px 14px;font-weight:700}
    .btn{border:1px solid var(--line);background:var(--surface);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer}
    .btn.action{width:100%}

    .period-display{margin-left:8px;font-weight:800;color:var(--muted)}

    #painelMetas{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px}
    @media(max-width:1200px){#painelMetas{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:700px){#painelMetas{grid-template-columns:1fr}}

    .metas-box{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow);
      text-align:center;cursor:pointer;min-height:170px;display:flex;flex-direction:column;justify-content:center;transition:.18s}
    .metas-box:hover{transform:translateY(-3px)}
    .metas-box h2{margin:0 0 6px;font-size:1.05rem;text-transform:uppercase}
    .metas-box p{margin:4px 0;font-size:.9rem}
    .metas-box.ok{border-color:var(--ok)}
    .metas-box.bad{border-color:var(--bad)}

    .tooltip{position:relative}
    .tooltip:hover::after{content:attr(data-tip);position:absolute;bottom:110%;left:50%;transform:translateX(-50%);
      background:#111;color:#fff;padding:6px 10px;border-radius:8px;font-size:.8rem;white-space:nowrap}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:55}
    .modal.open{display:flex}
    .modal-card{background:var(--surface);border:1px solid var(--line);border-radius:14px;max-width:1000px;width:96%;padding:16px;box-shadow:var(--shadow)}
    #graficoEmpresa{width:100%!important;height:360px!important}
  </style>
</head>
<body>
  <header>
    <div class="head">
      <a class="brand" href="#"><img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true"/><span class="title">Metas de Receita</span></a>
    </div>
  </header>

  <div class="container">
    <div class="filters">
      <div class="field" style="display:flex;align-items:center;gap:6px">
        <button id="rangeBtn" class="picker-btn">üóìÔ∏è Selecionar</button>
        <span id="rangeHint" class="period-display"></span>
      </div>
      <div class="field"><select id="empresaFiltro"><option value="">Todas</option></select></div>
      <div class="field"><button id="btnFiltrar" class="btn action">Filtrar</button></div>
    </div>
    <div id="painelMetas"></div>
  </div>

  <div id="modal" class="modal"><div class="modal-card"><h3 id="modalTitle"></h3><canvas id="graficoEmpresa"></canvas></div></div>

<script>
const urlBase='/api/meta';
const BRL=n=>(Number(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2});
const ISO=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const DMY=d=>`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
let range={start:null,end:null},chartEmpresa=null;

function setYesterdayDefault(){
  const hoje=new Date();const y=new Date(hoje);y.setDate(hoje.getDate()-1);
  range.start=y;range.end=y;document.getElementById('rangeHint').textContent=`${DMY(y)} ‚Üí ${DMY(y)}`;
}

function isMonthClosed(){
  if(!range.start||!range.end)return false;
  const sameMY=range.start.getMonth()===range.end.getMonth()&&range.start.getFullYear()===range.end.getFullYear();
  if(!sameMY)return false;
  const last=new Date(range.end.getFullYear(),range.end.getMonth()+1,0).getDate();
  return range.start.getDate()===1 && range.end.getDate()===last;
}

async function carregarMetas(){
  const painel=document.getElementById('painelMetas');painel.innerHTML='';
  const params=new URLSearchParams();
  if(range.start)params.append('dataInicio',ISO(range.start));
  if(range.end)params.append('dataFim',ISO(range.end));
  const rsp=await fetch(`${urlBase}?${params}`);const metas=await rsp.json();
  if(!metas.length){painel.innerHTML='<p>Nenhum dado encontrado</p>';return;}
  const monthClosed=isMonthClosed();

  metas.forEach(linha=>{
    const previsto=parseFloat(linha.Previsto);
    const realizado=parseFloat(String(linha.Realizado).replace(',','.'));
    const atingido=previsto>0?(realizado/previsto*100):0;

    // c√°lculo da previs√£o
    const diasNoMes=new Date(range.end.getFullYear(),range.end.getMonth()+1,0).getDate();
    const diasPassados=(range.end.getDate()-range.start.getDate()+1)||1;
    const mediaDia=realizado/diasPassados;
    const previsaoFinal=mediaDia*diasNoMes;
    const previsaoPct=previsto>0?(previsaoFinal/previsto*100):0;

    const ok=realizado>=previsto;
    const div=document.createElement('div');
    div.className=`metas-box tooltip ${monthClosed?(ok?'ok':'bad'):''}`;
    div.setAttribute('data-tip',`Realizado: R$ ${BRL(realizado)}`);
    div.innerHTML=`
      <h2>${linha.Empresa}</h2>
      <p>üí∞ Previsto: R$ ${BRL(previsto)}</p>
      <p>‚úÖ Realizado: R$ ${BRL(realizado)}</p>
      <p>üìä Atingido: ${BRL(atingido)}%</p>
      <p>üìà Previs√£o: R$ ${BRL(previsaoFinal)} (${BRL(previsaoPct)}%)</p>
    `;
    div.addEventListener('click',()=>abrirEvolucaoEmpresa(linha.Empresa));
    painel.appendChild(div);
  });
}

async function abrirEvolucaoEmpresa(empresa){
  document.getElementById('modalTitle').textContent=`Evolu√ß√£o ‚Äî ${empresa}`;
  document.getElementById('modal').classList.add('open');
  const end=range.end||new Date();const y=end.getFullYear(),m=end.getMonth()+1;
  const di=`${y}-${String(m).padStart(2,'0')}-01`;const df=`${y}-${String(m).padStart(2,'0')}-${new Date(y,m,0).getDate()}`;
  const rsp=await fetch(`${urlBase}?dataInicio=${di}&dataFim=${df}&empresa=${empresa}`);const metas=await rsp.json();
  const labels=metas.map(m=>m.Data.split('-').reverse().join('/'));
  const vals=metas.map(m=>parseFloat(String(m.Realizado).replace(',','.')));
  const ctx=document.getElementById('graficoEmpresa').getContext('2d');
  if(chartEmpresa)chartEmpresa.destroy();
  chartEmpresa=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:empresa+' ‚Äî Realizado',data:vals,borderColor:'#2563eb',
    backgroundColor:'rgba(37,99,235,.12)',tension:.25,pointRadius:5,pointHoverRadius:8}]},
    options:{interaction:{mode:'nearest',intersect:true},plugins:{tooltip:{callbacks:{label:c=>'R$ '+BRL(c.raw)}}}}});
}
document.getElementById('modal').addEventListener('click',e=>{if(e.target.id==='modal')e.target.classList.remove('open')});
document.getElementById('btnFiltrar').addEventListener('click',carregarMetas);

setYesterdayDefault();carregarMetas();
</script>
</body>
</html>
