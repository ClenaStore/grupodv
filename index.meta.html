<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Metas de Receita - Grupo DV</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0b1020; --surface:#10172a; --card:#0f172a;
      --text:#e5e7eb; --muted:#94a3b8; --line:rgba(148,163,184,.25);
      --brand:#60a5fa; --brand-2:#22d3ee; --shadow:0 20px 60px rgba(2,6,23,.35);
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --surface:#fff; --card:#fff;
      --text:#0f172a; --muted:#475569; --line:#e5e7eb;
      --shadow:0 16px 36px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}

    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter:saturate(160%) blur(8px);
      background:color-mix(in srgb,var(--surface) 80%,transparent);
      border-bottom:1px solid var(--line);
    }
    .head-wrap{max-width:100%;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .brand img{height:42px}
    .title{font-weight:800;font-size:clamp(18px,1.6vw,22px)}
    .head-spacer{flex:1}
    .icon-btn{border:1px solid var(--line);background:var(--surface);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer}
    .user{position:relative}
    .user-btn{display:flex;align-items:center;gap:10px;cursor:pointer;border:1px solid var(--line);background:var(--surface);padding:6px 8px;border-radius:999px}
    .user-btn img{width:34px;height:34px;border-radius:50%}
    .user-menu{position:absolute;right:0;top:110%;background:var(--surface);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);min-width:200px;padding:6px;display:none}
    .user.open .user-menu{display:block}
    .user-menu a,.user-menu button{display:block;padding:10px 12px;border:none;background:transparent;text-align:left;width:100%;border-radius:10px;cursor:pointer;color:var(--text)}
    .user-menu a:hover,.user-menu button:hover{background:rgba(0,0,0,.06)}

    .container{padding:20px;max-width:100%;margin:auto}
    .filters{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px;align-items:end}
    .filters label{font-weight:800;font-size:.95em;color:var(--muted);display:block;margin-bottom:6px}
    .filters select{padding:10px;border-radius:8px;border:1px solid var(--line);background:var(--surface);color:var(--text);width:100%}
    .filters button{padding:10px 16px;border:1px solid var(--line);border-radius:8px;background:var(--surface);color:var(--text);font-weight:800;cursor:pointer}

    .periodo-wrap{position:relative}
    .periodo-btn{background:var(--surface);border:1px solid var(--line);border-radius:8px;padding:10px 12px;width:100%;text-align:left;cursor:pointer}
    .metas-box{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:var(--shadow);cursor:pointer}
    .metas-box h2{margin:0 0 10px;font-size:1.2em;color:var(--text)}
    .metas-box p{margin:5px 0;font-size:.95em}
    .chart-box{background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:20px;margin-bottom:20px}
    .chart-box canvas{width:100% !important;height:300px !important}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal.open{display:flex}
    .modal-card{background:var(--surface);color:var(--text);border-radius:14px;padding:20px;width:min(1000px,95%);max-height:90vh;overflow:auto;box-shadow:var(--shadow)}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .close-x{cursor:pointer;font-weight:bold;font-size:20px;color:var(--muted)}

    /* Loader */
    #loader{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:2000;display:none;align-items:center;justify-content:center;color:#fff;font-size:1.4rem;font-weight:bold}
  </style>
</head>
<body>
<header>
  <div class="head-wrap">
    <a class="brand" href="index.html"><img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true"><div class="title">Metas de Receita</div></a>
    <div class="head-spacer"></div>
    <button id="themeToggle" class="icon-btn">üåì Tema</button>
    <div class="user" id="userMenu">
      <button class="user-btn"><img src="https://github.com/ClenaStore/grupodv/blob/main/paste/Imagem%20do%20WhatsApp%20de%202025-09-08%20%C3%A0(s)%2011.54.12_884bebc9.jpg?raw=true"><strong style="font-size:13px">Leonardo</strong></button>
      <div class="user-menu"><a href="perfil.html">üë§ Meu Perfil</a><button onclick="logout()">üö™ Sair</button></div>
    </div>
  </div>
</header>

<div class="container">
  <div class="filters">
    <div class="periodo-wrap">
      <label>Per√≠odo:</label>
      <button id="btnPeriodo" class="periodo-btn">üìÖ <span id="periodoTexto"></span></button>
    </div>
    <div>
      <label>Empresa:</label>
      <select id="empresaFiltro"><option value="">Todas</option></select>
    </div>
    <div><button id="btnWhats">üì≤ WhatsApp</button></div>
  </div>
  <div id="painelMetas"></div>
</div>

<!-- Modal Evolu√ß√£o -->
<div class="modal" id="modalEvolucao">
  <div class="modal-card">
    <div class="modal-header"><h3 id="tituloEvolucao"></h3><span class="close-x" onclick="fecharModal()">&times;</span></div>
    <canvas id="graficoEvolucao"></canvas>
  </div>
</div>

<!-- Loader -->
<div id="loader">‚è≥ Carregando...</div>

<script>
const urlBase='/api/meta'; let chartEvolucao=null;
let inicio=null,fim=null;
const BRL=v=>(+v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

function setOntem(){
  const hoje=new Date(); hoje.setDate(hoje.getDate()-1);
  inicio=fim=new Date(hoje);
  document.getElementById("periodoTexto").textContent=hoje.toLocaleDateString();
}
setOntem();
window.onload=()=>carregarMetas();

async function carregarMetas(){
  toggleLoader(true);
  const painel=document.getElementById("painelMetas"); painel.innerHTML="";
  const params=new URLSearchParams();
  if(inicio) params.append("dataInicio",inicio.toISOString().split('T')[0]);
  if(fim) params.append("dataFim",fim.toISOString().split('T')[0]);
  try{
    const r=await fetch(`${urlBase}?${params.toString()}`); const metas=await r.json();
    if(!metas.length){painel.innerHTML="<p style='text-align:center'>Nenhum dado.</p>";toggleLoader(false);return;}
    const empresas=[...new Set(metas.map(m=>m.Empresa))];
    const select=document.getElementById("empresaFiltro");
    if(select.options.length<=1){empresas.forEach(e=>{let opt=document.createElement("option");opt.value=e;opt.textContent=e;select.appendChild(opt);});}
    metas.forEach(linha=>{
      const div=document.createElement("div"); div.className="metas-box";
      div.innerHTML=`<h2>${linha.Empresa}</h2><p>üí∞ Previsto: ${BRL(linha.Previsto)}</p><p>‚úÖ Realizado: ${BRL(linha.Realizado)}</p>`;
      div.onclick=()=>abrirEvolucao(linha.Empresa);
      painel.appendChild(div);
    });
  }catch(e){console.error(e);painel.innerHTML="Erro ao carregar";}
  toggleLoader(false);
}

function abrirEvolucao(empresa){
  document.getElementById("modalEvolucao").classList.add("open");
  document.getElementById("tituloEvolucao").textContent=`Evolu√ß√£o - ${empresa}`;
  const ctx=document.getElementById("graficoEvolucao").getContext("2d");
  if(chartEvolucao){chartEvolucao.destroy();}
  chartEvolucao=new Chart(ctx,{type:'line',data:{labels:["01","05","10","15","20","25","30"],datasets:[{label:"Faturamento",data:[10,20,15,25,40,60,80],borderColor:'#60a5fa',fill:false,tension:.3}]},options:{responsive:true}});
}
function fecharModal(){document.getElementById("modalEvolucao").classList.remove("open");if(chartEvolucao){chartEvolucao.destroy();chartEvolucao=null;}}
function toggleLoader(show){document.getElementById("loader").style.display=show?"flex":"none";}
function logout(){localStorage.removeItem('dv_pwd');location.reload();}
</script>
</body>
</html>
