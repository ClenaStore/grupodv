<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Metas de Receita - Grupo DV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ===== Visual antigo (simples) ===== */
    :root{
      --bg:#f7f7f7; --card:#fff; --line:#e5e7eb; --text:#0f172a;
      --muted:#475569; --shadow:0 6px 18px rgba(0,0,0,.06);
      --accent:#1e1e2f; --accent-2:#111827;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); }

    header{
      background:#fff; padding:12px 20px; display:flex; align-items:center; gap:16px;
      border-bottom:1px solid #ccc; position:sticky; top:0; z-index:10;
    }
    header img{ height:50px }
    header h1{ margin:0 auto; font-size:1.6em; font-weight:bold; text-align:center; flex:1 }

    /* Tela cheia no desktop */
    .container{ padding:20px; max-width:100%; margin:0 auto; }

    .filters{
      display:flex; flex-wrap:wrap; gap:12px; align-items:end; margin-bottom:16px;
    }
    .filters > div{ flex:1 1 200px; min-width:200px }
    .filters label{ font-weight:bold; color:var(--muted); display:block; margin-bottom:6px }
    .filters input[type="date"], .filters select{
      width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; background:#fff;
    }
    .filters button{
      padding:10px 16px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;
    }
    .btn-dark{ background:var(--accent); color:#fff }
    .btn{ background:#fff; border:1px solid #ccc; }

    /* Cards */
    .cards{
      display:grid; gap:16px;
      grid-template-columns: repeat(3, minmax(260px, 1fr));
    }
    @media (max-width:1100px){ .cards{ grid-template-columns: repeat(2, minmax(260px, 1fr)); } }
    @media (max-width:680px){ .cards{ grid-template-columns: 1fr; } }

    .meta-card{
      background:var(--card); border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow);
      padding:16px; cursor:pointer; transition:.15s transform, .15s box-shadow;
    }
    .meta-card:hover{ transform:translateY(-3px); box-shadow:0 10px 24px rgba(0,0,0,.08) }
    .meta-card h2{ margin:0 0 8px; font-size:1.1em; color:#2c3e50 }
    .meta-card .row{ display:flex; align-items:center; justify-content:space-between; margin:8px 0 }
    .label{ color:var(--muted) }
    .kpi{ font-weight:800 }

    /* Loading overlay */
    #loading{
      position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:1000;
    }
    #loading .box{
      background:#111827; color:#fff; padding:14px 18px; border-radius:10px; box-shadow:var(--shadow); font-weight:800;
    }

    /* Modal (igual ao resumo financeiro) */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:20px; z-index:1001 }
    .modal.open{ display:flex }
    .modal-card{
      width:min(1100px, 96vw); background:#fff; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.2);
      padding:18px; max-height:92vh; overflow:auto; color:#0f172a; border:1px solid #e5e7eb;
    }
    .modal-header{ display:flex; align-items:center; gap:12px; margin-bottom:10px }
    .modal-header h3{ margin:0; font-size:1.1rem }
    .close-x{ margin-left:auto; cursor:pointer; font-weight:bold; font-size:20px; color:#374151 }
    #graficoWrap{ height:380px; border:1px solid #e5e7eb; border-radius:12px; padding:10px }
    #graficoMes{ width:100% !important; height:100% !important }
  </style>

  <!-- Prote√ß√£o por senha + interceptador (mesmo padr√£o que voc√™ usa) -->
  <script>
  (function(){
    const KEY_NAME='dv_pwd';
    async function ensurePassword(){
      let pwd = localStorage.getItem(KEY_NAME) || '';
      while(!pwd){
        pwd = prompt('Digite a senha de acesso:') || '';
        if(!pwd) continue;
        try{
          const r = await fetch('/api/ping', { headers:{'x-api-key': pwd} });
          if(r.ok){ localStorage.setItem(KEY_NAME, pwd); break; }
          else { alert('Senha incorreta.'); pwd=''; }
        }catch(e){
          localStorage.setItem(KEY_NAME, pwd); break;
        }
      }
    }
    const _fetch = window.fetch.bind(window);
    window.fetch = (input, init={})=>{
      let url = (typeof input==='string')?input:(input&&input.url)||'';
      init = init||{};
      const headers = new Headers(init.headers || ((typeof input!=='string' && input.headers) || {}));
      const pwd = localStorage.getItem(KEY_NAME)||'';
      if(url.startsWith('/api/') && pwd){ headers.set('x-api-key', pwd); }
      return _fetch(input, Object.assign({}, init, { headers }));
    };
    if(!localStorage.getItem(KEY_NAME)){ ensurePassword(); }
  })();
  </script>
</head>
<body>

  <!-- Loading -->
  <div id="loading"><div class="box">‚è≥ Carregando‚Ä¶</div></div>

  <header>
    <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo">
    <h1>üìä Painel de Metas - Grupo DV</h1>
  </header>

  <div class="container">
    <!-- Filtros (visual antigo + ‚ÄúPesquisar dia‚Äù) -->
    <div class="filters">
      <div>
        <label>Data In√≠cio:</label>
        <input type="date" id="dataInicio">
      </div>
      <div>
        <label>Data Fim:</label>
        <input type="date" id="dataFim">
      </div>
      <div>
        <label>Pesquisar dia:</label>
        <input type="date" id="diaBusca">
      </div>
      <div>
        <label>Empresa:</label>
        <select id="empresaFiltro"><option value="">Todas</option></select>
      </div>
      <div style="display:flex; gap:8px; align-items:end">
        <button id="btnOntem" class="btn">Ontem</button>
        <button id="btnUlt7" class="btn">√öltimos 7 dias</button>
        <button id="btnAplicar" class="btn-dark">Aplicar</button>
      </div>
    </div>

    <!-- Cards (um por empresa) -->
    <div class="cards" id="cards"></div>
  </div>

  <!-- Modal evolu√ß√£o mensal -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="modalTitulo">Evolu√ß√£o mensal</h3>
        <span class="close-x" id="fecharModal">&times;</span>
      </div>
      <div id="graficoWrap"><canvas id="graficoMes"></canvas></div>
    </div>
  </div>

  <script>
  /* ===== Config Chart ‚Äì bolinha maior + hit em linha e celular ===== */
  const POINT_RADIUS = 5, HOVER_RADIUS = 9, HIT_RADIUS = 28;
  Chart.defaults.elements.point.radius = POINT_RADIUS;
  Chart.defaults.elements.point.hoverRadius = HOVER_RADIUS;
  Chart.defaults.elements.point.hitRadius = HIT_RADIUS;
  Chart.defaults.interaction.mode = 'nearest';
  Chart.defaults.interaction.intersect = false;
  Chart.defaults.events = ['mousemove','mouseout','click','touchstart','touchmove','touchend'];

  /* ===== Utils ===== */
  const $ = s => document.querySelector(s);
  const showLoading = on => { $('#loading').style.display = on?'flex':'none'; };
  const BRL = n => (Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const pad2 = n => String(n).padStart(2,'0');
  const toISO = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const parseISO = s => { const [y,m,d]=String(s).split('-').map(Number); return new Date(y,(m||1)-1,d||1); };
  const diffDaysInc = (a,b)=> Math.floor((b - a)/(24*3600*1000)) + 1;
  const daysInMonth = (y,m)=> new Date(y,m+1,0).getDate(); // m: 0-11
  const fmtBR = d => d.toLocaleDateString('pt-BR');

  /* ===== Estado ===== */
  const API = '/api/meta';
  let dados = [];             // dataset bruto
  let rangeIni, rangeFim;     // datas selecionadas
  let empresaSel = '';        // filtro empresa ('' = todas)
  let chartMes = null;        // refer√™ncia do gr√°fico do modal

  /* ===== Inicializa√ß√£o ===== */
  window.addEventListener('load', async ()=>{
    // padr√£o: ontem
    const hoje = new Date();
    const ontem = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()-1);
    rangeIni = new Date(ontem); rangeFim = new Date(ontem);
    $('#dataInicio').value = toISO(rangeIni);
    $('#dataFim').value = toISO(rangeFim);
    $('#diaBusca').value = toISO(rangeIni);

    await carregar();
    aplicar(); // monta cards padr√£o (ontem)
  });

  async function carregar(){
    showLoading(true);
    try{
      const r = await fetch(API);
      dados = await r.json();

      // popular empresas
      const empresas = [...new Set(dados.map(x=>x.Empresa))].sort();
      const sel = $('#empresaFiltro');
      sel.innerHTML = '<option value="">Todas</option>' + empresas.map(e=>`<option>${e}</option>`).join('');
    }catch(e){
      console.error(e);
      $('#cards').innerHTML = `<div class="meta-card" style="grid-column:1/-1"><h2>N√£o foi poss√≠vel carregar os dados agora.</h2></div>`;
    }finally{
      showLoading(false);
    }
  }

  /* ===== Aplicar filtros ===== */
  function aplicar(){
    showLoading(true);
    setTimeout(()=>{
      // l√™ filtros
      const iniStr = $('#dataInicio').value;
      const fimStr = $('#dataFim').value;
      const diaStr = $('#diaBusca').value;
      empresaSel = $('#empresaFiltro').value || '';

      // se ‚ÄúPesquisar dia‚Äù preenchido, for√ßa range = dia
      if(diaStr){
        rangeIni = parseISO(diaStr);
        rangeFim = parseISO(diaStr);
        // sincroniza inputs
        $('#dataInicio').value = diaStr;
        $('#dataFim').value = diaStr;
      }else{
        rangeIni = iniStr ? parseISO(iniStr) : rangeIni;
        rangeFim = fimStr ? parseISO(fimStr) : rangeFim;
      }

      renderCards();
      showLoading(false);
    }, 20);
  }

  /* ===== L√≥gica de c√°lculo conforme suas regras =====
     - Resultado do per√≠odo = (√∫ltimo Realizado) - (primeiro Realizado)
     - % da meta = resultado / Previsto
     - M√©dia por dia = resultado / (dias no per√≠odo, inclusivo)
     - Previs√£o do m√™s = m√©dia por dia * (dias do m√™s da data final)
  */
  function renderCards(){
    const iniISO = toISO(rangeIni), fimISO = toISO(rangeFim);
    const mapa = new Map(); // emp -> lista de registros no per√≠odo

    dados.forEach(row=>{
      const emp = row.Empresa || '';
      if(empresaSel && emp !== empresaSel) return;
      const data = String(row.Data||'');
      if(data < iniISO || data > fimISO) return;
      if(!mapa.has(emp)) mapa.set(emp, []);
      mapa.get(emp).push(row);
    });

    const itens = [];
    mapa.forEach((lista, emp)=>{
      // ordena por data
      lista.sort((a,b)=> new Date(a.Data) - new Date(b.Data));

      const first = lista[0];
      const last = lista[lista.length-1];

      // Previsto (meta mensal) ‚Äî usa do last ou first
      const previsto = parseFloat(String((last?.Previsto ?? first?.Previsto) || 0).toString().replace(',','.')) || 0;

      // Realizado (pode vir com v√≠rgula)
      const rFirst = parseFloat(String(first?.Realizado ?? 0).toString().replace(',','.')) || 0;
      const rLast  = parseFloat(String(last?.Realizado  ?? 0).toString().replace(',','.')) || 0;

      const resultado = rLast - rFirst; // regra principal
      const diasPeriodo = Math.max(1, diffDaysInc(rangeIni, rangeFim));
      const mediaDia = resultado / diasPeriodo;

      const y = rangeFim.getFullYear(), m = rangeFim.getMonth();
      const diasMes = daysInMonth(y, m);
      const previsaoMes = mediaDia * diasMes;

      const percMeta = previsto > 0 ? (resultado/previsto)*100 : 0;

      itens.push({ emp, previsto, resultado, mediaDia, previsaoMes, percMeta });
    });

    // ordena por maior resultado
    itens.sort((a,b)=> b.resultado - a.resultado);

    const cards = $('#cards');
    if(itens.length === 0){
      cards.innerHTML = `<div class="meta-card" style="grid-column:1/-1"><h2>Nenhum dado no per√≠odo.</h2></div>`;
      return;
    }

    cards.innerHTML = itens.map(item => `
      <div class="meta-card" data-emp="${item.emp}">
        <h2>${item.emp}</h2>

        <div class="row"><div class="label">Resultado do per√≠odo</div><div class="kpi">${BRL(item.resultado)}</div></div>
        <div class="row"><div class="label">% da meta</div><div class="kpi">${(item.percMeta||0).toLocaleString('pt-BR',{maximumFractionDigits:2})}%</div></div>
        <div class="row"><div class="label">M√©dia por dia</div><div class="kpi">${BRL(item.mediaDia)}</div></div>
        <div class="row"><div class="label">Previs√£o do m√™s</div><div class="kpi">${BRL(item.previsaoMes)}</div></div>
        <div class="row"><div class="label">Meta mensal (Previsto)</div><div class="kpi">${BRL(item.previsto)}</div></div>
      </div>
    `).join('');

    // click -> modal evolu√ß√£o mensal do m√™s do fim do per√≠odo (se for 1 dia, √© o m√™s desse dia)
    cards.querySelectorAll('.meta-card').forEach(card=>{
      card.addEventListener('click', ()=> abrirEvolucao(card.getAttribute('data-emp')));
    });
  }

  /* ===== Bot√µes r√°pidos ===== */
  $('#btnOntem').addEventListener('click', ()=>{
    const hoje = new Date();
    const ontem = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()-1);
    $('#dataInicio').value = toISO(ontem);
    $('#dataFim').value   = toISO(ontem);
    $('#diaBusca').value  = toISO(ontem);
    aplicar();
  });

  $('#btnUlt7').addEventListener('click', ()=>{
    const hoje = new Date();
    const fim = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()-1);
    const ini = new Date(fim.getFullYear(), fim.getMonth(), fim.getDate()-6);
    $('#dataInicio').value = toISO(ini);
    $('#dataFim').value    = toISO(fim);
    $('#diaBusca').value   = ''; // limpa pesquisa-dia
    aplicar();
  });

  $('#btnAplicar').addEventListener('click', aplicar);

  // se digitar um ‚Äúdia‚Äù espec√≠fico, sincroniza in√≠cio/fim ao aplicar
  $('#diaBusca').addEventListener('change', ()=>{
    const d = $('#diaBusca').value;
    if(d){ $('#dataInicio').value = d; $('#dataFim').value = d; }
  });

  /* ===== Modal: evolu√ß√£o mensal (empresa, m√™s do fim do per√≠odo) ===== */
  const modal = $('#modal'), fecharModal = $('#fecharModal');
  fecharModal.addEventListener('click', ()=> closeModal());
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

  function closeModal(){
    modal.classList.remove('open');
    if(chartMes){ chartMes.destroy(); chartMes=null; }
  }

  function abrirEvolucao(empresa){
    // refer√™ncia de m√™s: fim do per√≠odo
    const y = rangeFim.getFullYear(), m = rangeFim.getMonth();
    const mesIni = new Date(y, m, 1);
    const mesFim = new Date(y, m, daysInMonth(y,m));

    // filtra dados do m√™s para a empresa
    const iniISO = toISO(mesIni), fimISO = toISO(mesFim);
    const linhas = dados.filter(r => r.Empresa===empresa && String(r.Data)>=iniISO && String(r.Data)<=fimISO)
                        .sort((a,b)=> new Date(a.Data) - new Date(b.Data));

    const labels = linhas.map(l => {
      const [yy,mm,dd] = l.Data.split('-'); return `${dd}/${mm}`;
    });
    const valores = linhas.map(l => parseFloat(String(l.Realizado||0).toString().replace(',','.')) || 0);

    // t√≠tulo
    const nomeMes = mesIni.toLocaleString('pt-BR',{month:'long',year:'numeric'});
    $('#modalTitulo').textContent = `Evolu√ß√£o mensal ‚Äî ${empresa} (${nomeMes})`;

    // desenha
    const ctx = document.getElementById('graficoMes').getContext('2d');
    if(chartMes) chartMes.destroy();
    chartMes = new Chart(ctx, {
      type:'line',
      data:{
        labels,
        datasets: [{
          label: 'Realizado (R$)',
          data: valores,
          borderColor:'#2563eb',
          backgroundColor:'rgba(37,99,235,.15)',
          fill:true,
          tension:.25,
          pointRadius:POINT_RADIUS,
          pointHoverRadius:HOVER_RADIUS,
          pointHitRadius:HIT_RADIUS
        }]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        interaction:{ mode:'nearest', intersect:false },
        plugins:{
          legend:{ display:true },
          tooltip:{ callbacks:{ label:c => 'R$ ' + (Number(c.parsed.y)||0).toLocaleString('pt-BR') } }
        },
        scales:{
          y:{ beginAtZero:true, ticks:{ callback:v=>'R$ '+Number(v).toLocaleString('pt-BR') } }
        }
      }
    });

    modal.classList.add('open');
  }
  </script>
</body>
</html>
