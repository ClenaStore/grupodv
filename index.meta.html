<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Metas de Receita - Grupo DV</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg: #0b1020; --surface:#10172a; --card:#0f172a;
      --text:#e5e7eb; --muted:#94a3b8; --line:rgba(148,163,184,.25);
      --brand:#60a5fa; --brand-2:#22d3ee;
      --shadow:0 20px 60px rgba(2,6,23,.35);
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --surface:#fff; --card:#fff;
      --text:#0f172a; --muted:#475569; --line:#e5e7eb;
      --shadow:0 16px 36px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:ui-sans-serif,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}

    /* Header */
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(160%) blur(8px);
      background:color-mix(in srgb,var(--surface) 80%,transparent);
      border-bottom:1px solid var(--line);
    }
    .head-wrap{
      max-width:1200px; margin:0 auto; padding:14px 18px;
      display:flex; align-items:center; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit}
    .brand img{height:42px}
    .title{font-weight:800; font-size:clamp(18px,1.6vw,22px)}
    .head-spacer{flex:1}
    .icon-btn{
      border:1px solid var(--line); background:var(--surface);
      color:var(--text); padding:10px 12px; border-radius:12px;
      font-weight:800; cursor:pointer; display:inline-flex; gap:6px;
    }
    .user{position:relative}
    .user-btn{
      display:flex; align-items:center; gap:10px; cursor:pointer;
      border:1px solid var(--line); background:var(--surface);
      padding:6px 8px; border-radius:999px;
    }
    .user-btn img{width:34px; height:34px; border-radius:50%}
    .user-menu{
      position:absolute; right:0; top:110%; background:var(--surface);
      border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow);
      min-width:200px; padding:6px; display:none;
    }
    .user.open .user-menu{display:block}
    .user-menu a, .user-menu button{
      display:block; padding:10px 12px; border:none; background:transparent;
      text-align:left; width:100%; border-radius:10px; cursor:pointer; color:var(--text);
    }
    .user-menu a:hover, .user-menu button:hover{background:rgba(0,0,0,.06)}

    /* Container */
    .container{padding:20px; max-width:1200px; margin:auto}

    /* Filtros */
    .filters{display:flex; flex-wrap:wrap; gap:12px; margin-bottom:20px; align-items:end}
    .filters label{font-weight:800; font-size:.95em; color:var(--muted); display:block; margin-bottom:6px}
    .filters select,.filters input{padding:10px; border-radius:8px; border:1px solid var(--line); background:var(--surface); color:var(--text); width:100%}
    .filters button{padding:10px 16px; border:1px solid var(--line); border-radius:8px; background:var(--surface); color:var(--text); font-weight:800; cursor:pointer}

    /* CalendÃ¡rio popover */
    .periodo-wrap{position:relative}
    .periodo-btn{background:var(--surface); border:1px solid var(--line); border-radius:8px; padding:10px 12px; width:100%; text-align:left; cursor:pointer}
    .popover{position:absolute; top:100%; left:0; margin-top:8px; z-index:50; background:var(--surface); border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow); width:300px; padding:12px; display:none}
    .popover.open{display:block}
    .popover .row{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .popover input{width:100%; padding:8px; margin-bottom:6px; border-radius:8px; border:1px solid var(--line); background:var(--surface); color:var(--text)}

    /* Cards */
    .metas-box{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:var(--shadow)}
    .metas-box h2{margin:0 0 10px; font-size:1.2em; color:var(--text)}
    .metas-box p{margin:5px 0; font-size:.95em}

    /* Chart */
    .chart-box{background:var(--card); border-radius:12px; box-shadow:var(--shadow); padding:20px; margin-bottom:20px}
    .chart-box canvas{width:100% !important; height:300px !important}
  </style>

  <!-- Senha + Tema -->
  <script>
  (function(){
    const KEY_NAME='dv_pwd';
    const savedTheme=localStorage.getItem('dv_theme');
    if(savedTheme){document.documentElement.setAttribute('data-theme',savedTheme);}
    window.__toggleTheme=()=>{const cur=document.documentElement.getAttribute('data-theme')||'light';const next=(cur==='light')?'dark':'light';document.documentElement.setAttribute('data-theme',next);localStorage.setItem('dv_theme',next);}
    async function ensurePassword(){
      let pwd=localStorage.getItem(KEY_NAME)||''; while(!pwd){pwd=prompt('Digite a senha de acesso:')||''; if(!pwd) continue; try{const r=await fetch('/api/ping',{headers:{'x-api-key':pwd}}); if(r.ok){localStorage.setItem(KEY_NAME,pwd); break;} else{alert('Senha incorreta.'); pwd='';}}catch(e){localStorage.setItem(KEY_NAME,pwd); break;}}
    }
    const _fetch=window.fetch.bind(window);
    window.fetch=(input,init={})=>{let url=(typeof input==='string')?input:(input&&input.url)||''; init=init||{}; const headers=new Headers(init.headers||(typeof input!=='string'&&input.headers)||{}); const pwd=localStorage.getItem(KEY_NAME)||''; if(url.startsWith('/api/')&&pwd){headers.set('x-api-key',pwd);} return _fetch(input,Object.assign({},init,{headers}));};
    if(!localStorage.getItem(KEY_NAME)){ensurePassword();}
  })();
  </script>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="head-wrap">
      <a class="brand" href="index.html">
        <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo">
        <div class="title">Metas de Receita</div>
      </a>
      <div class="head-spacer"></div>
      <button id="themeToggle" class="icon-btn">ðŸŒ“ Tema</button>
      <div class="user" id="userMenu">
        <button class="user-btn"><img src="https://github.com/ClenaStore/grupodv/blob/main/paste/Imagem%20do%20WhatsApp%20de%202025-09-08%20%C3%A0(s)%2011.54.12_884bebc9.jpg?raw=true" alt=""><strong style="font-size:13px">Leonardo</strong></button>
        <div class="user-menu">
          <a href="perfil.html">ðŸ‘¤ Meu Perfil</a>
          <button onclick="logout()">ðŸšª Sair</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Filtros -->
    <div class="filters">
      <div class="periodo-wrap">
        <label>PerÃ­odo:</label>
        <button id="btnPeriodo" type="button" class="periodo-btn">ðŸ“… <span id="periodoTexto">Selecionar</span></button>
        <div id="popoverPeriodo" class="popover">
          <label>InÃ­cio</label><input type="date" id="dataInicio">
          <label>Fim</label><input type="date" id="dataFim">
          <div class="row">
            <button id="ontem">Ontem</button>
            <button id="ult7">Ãšltimos 7</button>
            <button id="mes">Este mÃªs</button>
          </div>
          <div class="row" style="justify-content:flex-end"><button id="aplicar">Aplicar</button></div>
        </div>
      </div>
      <div>
        <label>Empresa:</label>
        <select id="empresaFiltro"><option value="">Todas</option></select>
      </div>
      <div><button id="btnWhats">ðŸ“² WhatsApp</button></div>
    </div>

    <div id="painelMetas"></div>

    <div class="chart-box" id="graficoContainer">
      <h3>ðŸ“ˆ EvoluÃ§Ã£o do Faturamento</h3>
      <canvas id="graficoFaturamento"></canvas>
    </div>
  </div>

<script>
const urlBase='/api/meta'; let chart;
const BRL=v=>(+v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

document.getElementById('themeToggle').addEventListener('click',()=>window.__toggleTheme&&window.__toggleTheme());
const user=document.getElementById('userMenu');user.querySelector('.user-btn').addEventListener('click',()=>user.classList.toggle('open'));window.addEventListener('click',e=>{if(!user.contains(e.target)) user.classList.remove('open')});
function logout(){localStorage.removeItem('dv_pwd'); location.reload();}

function preencherOntem(){const hoje=new Date(); hoje.setDate(hoje.getDate()-1); const d=hoje.toISOString().split('T')[0]; document.getElementById("dataInicio").value=d; document.getElementById("dataFim").value=d; document.getElementById("periodoTexto").textContent=`${d}`;}
window.onload=()=>{preencherOntem(); carregarMetas();};

async function carregarMetas(){
  const painel=document.getElementById("painelMetas"); painel.innerHTML="Carregando...";
  const dataInicio=document.getElementById("dataInicio").value; const dataFim=document.getElementById("dataFim").value; const empresa=document.getElementById("empresaFiltro").value;
  try{
    const r=await fetch(`${urlBase}?dataInicio=${dataInicio}&dataFim=${dataFim}&empresa=${empresa}`); const metas=await r.json();
    const empresas=[...new Set(metas.map(m=>m.Empresa))]; const sel=document.getElementById("empresaFiltro"); if(sel.options.length<=1){empresas.forEach(e=>{const o=document.createElement("option"); o.value=e; o.textContent=e; sel.appendChild(o);});}
    painel.innerHTML=""; if(!metas.length){painel.innerHTML="<p>Nenhum dado.</p>"; return;}
    metas.forEach(linha=>{
      const previsto=+linha.Previsto; const realizado=parseFloat(linha.Realizado.toString().replace(",",".")); const atingido=previsto?(realizado/previsto*100):0;
      const box=document.createElement("div"); box.className="metas-box"; box.innerHTML=`<h2>${linha.Empresa}</h2><p>ðŸ’° Previsto: ${BRL(previsto)}</p><p>âœ… Realizado: ${BRL(realizado)}</p><p>ðŸ“Š Atingido: ${atingido.toFixed(2)}%</p>`; painel.appendChild(box);
    });
  }catch(e){painel.innerHTML="Erro ao carregar";}
}
document.getElementById("btnWhats").addEventListener("click",()=>{const blocos=document.querySelectorAll(".metas-box"); if(!blocos.length) return alert("Nada."); let msg="ðŸ“Š Metas:\n\n"; blocos.forEach(b=>{msg+=b.innerText+"\n\n"}); window.open("https://wa.me/5577999761436?text="+encodeURIComponent(msg),"_blank");});

/* CalendÃ¡rio popover */
const btnPeriodo=document.getElementById('btnPeriodo'); const pop=document.getElementById('popoverPeriodo');
btnPeriodo.onclick=()=>pop.classList.toggle('open'); document.addEventListener('click',e=>{if(!pop.contains(e.target)&&!btnPeriodo.contains(e.target)) pop.classList.remove('open');});
document.getElementById('ontem').onclick=()=>{preencherOntem();};
document.getElementById('ult7').onclick=()=>{const hoje=new Date(); const fim=new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate()-1); const ini=new Date(fim); ini.setDate(fim.getDate()-6); document.getElementById("dataInicio").value=ini.toISOString().split('T')[0]; document.getElementById("dataFim").value=fim.toISOString().split('T')[0];};
document.getElementById('mes').onclick=()=>{const d=new Date(); const ini=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`; const fim=new Date(d.getFullYear(),d.getMonth()+1,0).toISOString().split('T')[0]; document.getElementById("dataInicio").value=ini; document.getElementById("dataFim").value=fim;};
document.getElementById('aplicar').onclick=()=>{carregarMetas(); pop.classList.remove('open');};
</script>
</body>
</html>
