<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Metas de Receita - Grupo DV</title>
  <script>try{var t=localStorage.getItem('dv_theme'); if(t){document.documentElement.setAttribute('data-theme', t);}}catch(e){}</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      /* tema escuro (padrÃ£o visual unificado) */
      --bg:#0b1020; --surface:#10172a; --card:#0f172a; --text:#e5e7eb;
      --muted:#94a3b8; --line:rgba(148,163,184,.25); --shadow:0 20px 60px rgba(2,6,23,.35);
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --surface:#ffffff; --card:#ffffff; --text:#0f172a;
      --muted:#475569; --line:#e5e7eb; --shadow:0 16px 36px rgba(15,23,42,.08);
    }

    body{
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg); color: var(--text); margin:0;
    }

    header{
      background: var(--surface); border-bottom:1px solid var(--line);
      padding: 14px 20px; display:flex; align-items:center; gap:12px;
      position: sticky; top: 0; z-index: 50;
    }
    header img{ height:46px }
    header h1{ flex:1; margin:0; text-align:center; font-size:1.4em; font-weight:800 }

    .container{ padding:20px; max-width:1200px; margin:auto }

    .filters{
      display:grid; grid-template-columns: repeat(6, minmax(0,1fr));
      gap:12px; margin-bottom:20px; align-items:end;
    }
    .filters > div{ min-width: 180px }
    .filters label{ display:block; font-weight:700; color:var(--muted); margin-bottom:6px; font-size:.95em }
    .filters select, .filters input[type="date"]{
      width:100%; padding:10px; border-radius:8px; border:1px solid var(--line);
      background: var(--surface); color: var(--text);
    }
    .filters button, #btnWhats{
      padding:10px 16px; border:1px solid var(--line); border-radius:8px;
      font-weight:700; cursor:pointer; background: var(--surface); color: var(--text);
    }
    #btnWhats{ background:#25d366; color:#fff; margin:10px 0; border-color:#25d366 }

    .metas-box{
      background: var(--card); border:1px solid var(--line);
      border-radius:10px; padding:20px; margin-bottom:16px; box-shadow: var(--shadow);
    }
    .metas-box h2{ margin:0 0 10px; font-size:1.1em; font-weight:800 }
    .metas-box p{ margin:4px 0; font-size:.95em; color: var(--text) }

    .chart-box{
      background: var(--card); border:1px solid var(--line);
      border-radius:10px; box-shadow: var(--shadow); padding:20px;
    }
    .chart-box h3{ margin-top:0 }

    /* Overlay de carregamento */
    #loading{
      position: fixed; inset:0; display:none; align-items:center; justify-content:center; flex-direction:column;
      background: rgba(2,6,23,.60); color:#fff; font-weight:800; z-index:2000;
    }
    #loading.show{ display:flex }
    .spinner{ width:44px; height:44px; border:4px solid rgba(255,255,255,.25); border-top-color:#fff; border-radius:50%;
      animation:spin 1s linear infinite; margin-bottom:10px }
    @keyframes spin{ to{ transform: rotate(360deg) } }

    @media (max-width: 768px){
      .filters{ grid-template-columns: 1fr }
    }
  </style>

  <!-- ProteÃ§Ã£o por senha + interceptador de fetch (mantidos) -->
  <script>
  (function(){
    const KEY_NAME = 'dv_pwd';

    async function ensurePassword(){
      let pwd = localStorage.getItem(KEY_NAME) || '';
      while(!pwd){
        pwd = prompt('Digite a senha de acesso:') || '';
        if(!pwd) continue;
        try{
          const r = await fetch('/api/ping', {headers:{'x-api-key': pwd }});
          if(r.ok){ localStorage.setItem(KEY_NAME, pwd); break; }
          else { alert('Senha incorreta.'); pwd=''; }
        }catch(e){
          localStorage.setItem(KEY_NAME, pwd); break;
        }
      }
    }

    // intercepta fetch para anexar senha automaticamente
    const _fetch = window.fetch.bind(window);
    window.fetch = (input, init={})=>{
      let url = (typeof input === 'string') ? input : (input && input.url) || '';
      init = init || {};
      const headers = new Headers(init.headers || ((typeof input !== 'string' && input.headers) || {}));
      const pwd = localStorage.getItem(KEY_NAME) || '';
      if(url.startsWith('/api/') && pwd){ headers.set('x-api-key', pwd); }
      return _fetch(input, Object.assign({}, init, { headers }));
    };

    if(!localStorage.getItem(KEY_NAME)){ ensurePassword(); }
  })();
  </script>
</head>
<body>

<header>
  <img src="https://github.com/ClenaStore/painel-principal/blob/main/img/GRUPO%20DV%20(1).png?raw=true" alt="Logo CB Systems">
  <h1>ðŸ“Š Painel de Metas - Grupo DV</h1>
</header>

<div class="container">
  <div class="filters">
    <div>
      <label>Data InÃ­cio:</label>
      <input type="date" id="dataInicio">
    </div>
    <div>
      <label>Data Fim:</label>
      <input type="date" id="dataFim">
    </div>
    <div>
      <label>Empresa:</label>
      <select id="empresaFiltro">
        <option value="">Todas</option>
      </select>
    </div>
    <div>
      <button onclick="carregarMetas()">Filtrar</button>
    </div>
  </div>

  <button id="btnWhats">ðŸ“² Enviar via WhatsApp</button>

  <div id="painelMetas"></div>

  <div class="chart-box" id="graficoContainer">
    <h3>ðŸ“ˆ EvoluÃ§Ã£o do Faturamento</h3>
    <canvas id="graficoFaturamento"></canvas>
  </div>
</div>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <div id="loadingText">Carregandoâ€¦</div>
</div>

<script>
/* ====== MELHORIAS NO CHART.JS (mantendo suas funÃ§Ãµes) ====== */
Chart.defaults.elements.point.radius = 6;
Chart.defaults.elements.point.hoverRadius = 10;
Chart.defaults.elements.point.hitRadius = 28;
Chart.defaults.interaction.mode = 'nearest';
Chart.defaults.interaction.intersect = false;
Chart.defaults.events = ['mousemove','mouseout','click','touchstart','touchmove','touchend'];

/* ====== SEU JS ORIGINAL (mantido) + overlay de carregamento ====== */
const urlBase = '/api/meta';
let chart;

function formatarNumero(valor) {
  return parseFloat(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
}

function formatarDataBR(dataISO) {
  const [y, m, d] = dataISO.split("-");
  return `${d}/${m}/${y}`;
}

function preencherDataOntem() {
  const hoje = new Date();
  const ontem = new Date(hoje);
  ontem.setDate(hoje.getDate() - 1);
  const dataFormatada = ontem.toISOString().split('T')[0];
  document.getElementById("dataInicio").value = dataFormatada;
  document.getElementById("dataFim").value = dataFormatada;
}

window.onload = () => {
  preencherDataOntem();
  carregarMetas();
};

function showLoading(msg){ const el=document.getElementById('loading'); document.getElementById('loadingText').textContent = msg||'Carregandoâ€¦'; el.classList.add('show'); }
function hideLoading(){ document.getElementById('loading').classList.remove('show'); }

async function carregarMetas() {
  showLoading('Carregando metasâ€¦');
  const painel = document.getElementById("painelMetas");
  painel.innerHTML = "";

  const dataInicio = document.getElementById("dataInicio").value;
  const dataFim = document.getElementById("dataFim").value;
  const empresa = document.getElementById("empresaFiltro").value;

  let diasCorridosNoMes = 30;
  let diasCorridosAteData = 30;

  if (dataFim) {
    const dataRef = new Date(dataFim);
    const mesRef = dataRef.getMonth();
    const anoRef = dataRef.getFullYear();
    const hoje = new Date();

    const ultimoDiaMesRef = new Date(anoRef, mesRef + 1, 0);
    diasCorridosNoMes = ultimoDiaMesRef.getDate();

    if (anoRef === hoje.getFullYear() && mesRef === hoje.getMonth()) {
      diasCorridosAteData = hoje.getDate();
    } else {
      diasCorridosAteData = dataRef.getDate();
    }
  }

  const params = new URLSearchParams();
  if (dataInicio) params.append("dataInicio", dataInicio);
  if (dataFim) params.append("dataFim", dataFim);
  if (empresa) params.append("empresa", empresa);

  try {
    const resposta = await fetch(`${urlBase}?${params.toString()}`);
    const metas = await resposta.json();

    const empresas = [...new Set(metas.map(m => m.Empresa))];
    const select = document.getElementById("empresaFiltro");
    if (select.options.length <= 1) {
      empresas.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e;
        opt.textContent = e;
        select.appendChild(opt);
      });
    }

    painel.innerHTML = "";
    if (metas.length === 0) {
      painel.innerHTML = "<p style='text-align:center; color:var(--muted)'>Nenhum dado encontrado.</p>";
      esconderGrafico();
      hideLoading();
      return;
    }

    metas.forEach(linha => {
      const previsto = parseFloat(linha["Previsto"]);
      const realizado = parseFloat(linha["Realizado"].toString().replace(",", "."));
      const atingido = previsto > 0 ? (realizado / previsto) * 100 : 0;
      const mediaDiaria = realizado / diasCorridosAteData;
      const previsaoFinal = mediaDiaria * diasCorridosNoMes;
      const previsaoPercentual = previsto > 0 ? (previsaoFinal / previsto) * 100 : 0;

      const div = document.createElement("div");
      div.className = "metas-box";
      div.innerHTML = `
        <h2>${linha["Empresa"]}</h2>
        <p>ðŸ’° Previsto: R$ ${formatarNumero(previsto)}</p>
        <p>âœ… Realizado: R$ ${formatarNumero(realizado)}</p>
        <p>ðŸ“Š Atingido: ${formatarNumero(atingido)}%</p>
        <p>ðŸ“… MÃ©dia por dia: R$ ${formatarNumero(mediaDiaria)}</p>
        <p>ðŸ“ˆ PrevisÃ£o: R$ ${formatarNumero(previsaoFinal)} (${formatarNumero(previsaoPercentual)}%)</p>
      `;
      painel.appendChild(div);
    });

    if (empresa) mostrarGrafico(metas);
    else esconderGrafico();

  } catch (e) {
    painel.innerHTML = "Erro ao carregar dados.";
    console.error(e);
  }
  hideLoading();
}

function mostrarGrafico(metas) {
  const ctx = document.getElementById('graficoFaturamento').getContext('2d');
  metas.sort((a, b) => new Date(a.Data) - new Date(b.Data));
  const dias = metas.map(m => m["Data"]?.split("-").reverse().join("/"));
  const valores = metas.map(m => parseFloat(m["Realizado"].toString().replace(",", ".")));

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dias,
      datasets: [{
        label: 'EvoluÃ§Ã£o do Faturamento',
        data: valores,
        fill: true,
        borderColor: '#388e3c',
        backgroundColor: 'rgba(56, 142, 60, 0.1)',
        tension: 0.3,
        pointRadius: 6,
        pointHoverRadius: 10,
        pointHitRadius: 28
      }]
    },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: false },
      plugins: { legend: { display: true }, title: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) { return 'R$ ' + value.toLocaleString('pt-BR'); }
          }
        }
      }
    }
  });
}

function esconderGrafico() {
  if (chart) { chart.destroy(); chart = null; }
  document.getElementById('graficoContainer').style.display = 'none';
}
</script>

<script>
// WhatsApp (mantido)
document.getElementById("btnWhats").addEventListener("click", () => {
  const dataInicio = document.getElementById("dataInicio").value;
  const dataFim = document.getElementById("dataFim").value;
  const periodo = (dataInicio && dataFim)
    ? `${formatarDataBR(dataInicio)} - ${formatarDataBR(dataFim)}`
    : "PerÃ­odo nÃ£o informado";

  const blocos = document.querySelectorAll(".metas-box");
  if (!blocos.length) return alert("Nenhum dado para enviar.");

  let mensagem = `ðŸ“† Resumo da meta de receitas ${periodo}\n\n`;
  blocos.forEach(box => {
    const titulo = box.querySelector("h2").innerText;
    const linhas = [...box.querySelectorAll("p")].map(p => p.innerText).join("\n");
    mensagem += `*${titulo}*\n${linhas}\n\n`;
  });

  const numero = "5577999761436";
  const link = `https://wa.me/${numero}?text=${encodeURIComponent(mensagem.trim())}`;
  window.open(link, "_blank");
});
</script>

</body>
</html>
