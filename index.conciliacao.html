<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Concilia√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --surface:#fff; --card:#fff; --text:#0f172a; --muted:#475569;
      --line:#e5e7eb; --shadow:0 16px 36px rgba(15,23,42,.08);
      --blue:#2563eb; --yellow:#f59e0b;
    }
    body{margin:0; font-family:sans-serif; background:var(--bg); color:var(--text);}
    header{background:var(--surface); border-bottom:1px solid var(--line); padding:12px 18px; font-weight:800}
    .container{max-width:1200px; margin:0 auto; padding:20px}
    .filters{display:grid; grid-template-columns:1fr 160px 160px; gap:12px; margin-bottom:20px}
    @media(max-width:700px){.filters{grid-template-columns:1fr;}}
    .field label{display:block; margin:0 0 4px; font-weight:700; color:var(--muted)}
    .field input,.field select{width:100%; padding:10px; border:1px solid var(--line); border-radius:10px;}

    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow:var(--shadow); padding:16px; margin-bottom:18px}
    .card h3{margin:0 0 12px}
    .flex{display:flex; gap:24px; flex-wrap:wrap; align-items:center; justify-content:space-around}

    .circle-wrap{display:flex; flex-direction:column; align-items:center; gap:10px}
    canvas{width:120px!important; height:120px!important}
    button{padding:8px 14px; border:1px solid var(--line); border-radius:10px; background:var(--surface); font-weight:700; cursor:pointer}

    table{width:100%; border-collapse:collapse; font-size:.95rem}
    th,td{padding:10px; border-bottom:1px solid var(--line); text-align:left}
    td:last-child,th:last-child{text-align:right}
  </style>
</head>
<body>
<header>üìä Painel de Concilia√ß√£o</header>

<div class="container">
  <!-- Filtros -->
  <div class="filters">
    <div class="field">
      <label>Empresa</label>
      <select id="fEmpresa"></select>
    </div>
    <div class="field">
      <label>Data in√≠cio</label>
      <input type="date" id="fIni">
    </div>
    <div class="field">
      <label>Data fim</label>
      <input type="date" id="fFim">
    </div>
  </div>

  <!-- KPIs -->
  <div class="card">
    <h3>Concilia√ß√£o</h3>
    <div class="flex">
      <div class="circle-wrap">
        <canvas id="grafCartao"></canvas>
        <button>Conciliar cart√µes</button>
      </div>
      <div class="circle-wrap">
        <canvas id="grafBanco"></canvas>
        <button>Conciliar bancos</button>
      </div>
    </div>
  </div>

  <!-- Pend√™ncias -->
  <div class="card">
    <h3>Valores Pendentes</h3>
    <table>
      <thead><tr><th>Data</th><th>Empresa</th><th>Tipo</th><th>Valor</th></tr></thead>
      <tbody id="tblPend"></tbody>
    </table>
  </div>
</div>

<script>
const API_URL="/api/concil"; // GAS endpoint

let chartCartao, chartBanco;
function criaDoughnut(el, valor, cor){
  const data = {
    datasets:[{data:[valor,100-valor], backgroundColor:[cor,"#e5e7eb"], cutout:"70%"}]
  };
  const cfg = {
    type:'doughnut', data,
    options:{plugins:{legend:{display:false},tooltip:{enabled:false}}},
    plugins:[{id:"text", beforeDraw(c){
      const {ctx,width}=c; ctx.save();
      ctx.font="bold 20px sans-serif"; ctx.fillStyle=cor;
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText(valor+"%", width/2, c.chartArea.height/2+20);
    }}]
  };
  return new Chart(document.getElementById(el), cfg);
}

async function carregar(){
  const res = await fetch(API_URL);
  const js = await res.json();

  // Empresas
  const empresas=[...new Set(js.map(r=>r.empresa))];
  const sel=document.getElementById("fEmpresa");
  sel.innerHTML=`<option value="">Todas</option>`+empresas.map(e=>`<option>${e}</option>`).join("");

  // Filtra
  function aplicar(){
    const emp=sel.value, ini=document.getElementById("fIni").value, fim=document.getElementById("fFim").value;
    const pend=js.filter(r=>{
      const okEmp=!emp||r.empresa===emp;
      const okIni=!ini||r.data>=ini;
      const okFim=!fim||r.data<=fim;
      return okEmp&&okIni&&okFim;
    });

    // Calcula %
    const totCart=pend.filter(r=>r.tipo==="Cart√£o").length;
    const concCart=pend.filter(r=>r.tipo==="Cart√£o" && r.status==="Conciliado").length;
    const percCart=totCart?(Math.round(concCart/totCart*100)):100;

    const totBco=pend.filter(r=>r.tipo==="Banco").length;
    const concBco=pend.filter(r=>r.tipo==="Banco" && r.status==="Conciliado").length;
    const percBco=totBco?(Math.round(concBco/totBco*100)):100;

    if(chartCartao) chartCartao.destroy();
    if(chartBanco) chartBanco.destroy();
    chartCartao=criaDoughnut("grafCartao", percCart, "#2563eb");
    chartBanco=criaDoughnut("grafBanco", percBco, "#f59e0b");

    // Pend√™ncias
    const tbody=document.getElementById("tblPend");
    tbody.innerHTML=pend.filter(r=>r.status!=="Conciliado")
      .map(r=>`<tr><td>${r.data}</td><td>${r.empresa}</td><td>${r.tipo}</td><td>R$ ${Number(r.valor).toLocaleString("pt-BR",{minimumFractionDigits:2})}</td></tr>`).join("");
  }
  aplicar();
  sel.onchange=aplicar; document.getElementById("fIni").onchange=aplicar; document.getElementById("fFim").onchange=aplicar;
}
carregar();
</script>
</body>
</html>
