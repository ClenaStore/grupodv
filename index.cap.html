<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Financeiro ‚Ä¢ Aprova√ß√£o & Saldos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    body { margin: 0; font-family: "Inter", sans-serif; background: #f8fafc; color: #111; }
    header { background: #1e3a8a; color: #fff; padding: 12px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 10; }

    .container { padding: 12px; display: flex; flex-direction: column; gap: 16px; }

    /* Gr√°fico */
    .grafico-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.1); padding: 16px; }
    #graficoModalidades { max-height: 240px; }

    .saldos-grid { margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px,1fr)); gap: 8px; }
    .saldo-card { background: #f1f5f9; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: bold; text-align: center; color: #111; }
    .saldo-card span { display: block; color: #1e3a8a; font-size: 14px; margin-top: 4px; }

    /* Filtros */
    .filtros { display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-between; }
    .filtros button, .filtros input[type="date"] {
      font-size: 13px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer;
    }
    .btn-refresh { background: #f59e0b; color: #fff; border: none; }

    /* Cards t√≠tulos (mobile) */
    .lista-titulos { display: flex; flex-direction: column; gap: 10px; }
    .titulo-card { background: #fff; border-radius: 10px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.1); font-size: 14px; }
    .titulo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .titulo-actions button { margin-left: 4px; }

    /* Bot√µes */
    button { cursor: pointer; }
    .btn-aprovar { background: #16a34a; color: #fff; border: none; padding: 4px 8px; border-radius: 6px; font-size: 12px; }
    .btn-negar { background: #dc2626; color: #fff; border: none; padding: 4px 8px; border-radius: 6px; font-size: 12px; }

    /* Desktop: tabela */
    @media(min-width: 768px){
      .lista-titulos { display: none; }
      table { display: table; width: 100%; border-collapse: collapse; background: #fff; font-size: 14px; }
      th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; }
      th { background: #f1f5f9; }
    }

    /* Overlay */
    #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,.9); display:none; align-items:center; justify-content:center; font-weight:bold; color:#1e3a8a; font-size:18px; z-index:9999; }
  </style>
</head>
<body>
  <header>Painel Financeiro</header>
  <div id="overlay">‚è≥ Carregando...</div>

  <div class="container">

    <div class="filtros">
      <div>
        <label>In√≠cio</label>
        <input type="date" id="dataInicio">
        <label>Fim</label>
        <input type="date" id="dataFim">
        <button onclick="aplicarDatas()">Aplicar</button>
      </div>
      <button class="btn-refresh" onclick="carregarTudo()">üîÑ Atualizar</button>
    </div>

    <div class="grafico-card">
      <canvas id="graficoModalidades"></canvas>
      <div id="saldosGrid" class="saldos-grid"></div>
    </div>

    <!-- Mobile -->
    <div class="lista-titulos" id="listaTitulos"></div>

    <!-- Desktop -->
    <table id="tabelaTitulos">
      <thead>
        <tr>
          <th><input type="checkbox" id="checkTodos" onchange="toggleTodos(this)"></th>
          <th>A√ß√µes</th>
          <th>Empresa</th>
          <th>Fornecedor</th>
          <th>Vencimento</th>
          <th>Valor</th>
          <th>Meio</th>
          <th>Hist√≥rico</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>

  <script>
    const endpointSaldos = "https://script.google.com/macros/s/AKfycbxsQCx_Aw0PXnAIPQsj1Hjq35BSolRmvpY3ye3DwKLLz_oTfKfQAGi3mT3Ygl-Tm3yl/exec";
    const endpointTitulos = "https://script.google.com/macros/s/AKfycbwCpe51vPoH2lG8YR89kVR_uRfg6-T7SNkWwI3LbJAvbNiqEA1pddhG_3llm8tINMCB/exec";

    let grafico, selecionados = {}, dataInicio, dataFim;

    function parseValor(v){ if(!v) return 0; return Number(v.toString().replace("R$","").replace(/\./g,"").replace(",",".").trim())||0; }
    function formatarData(iso){ try{return new Date(iso).toLocaleDateString("pt-BR");}catch{return iso;} }

    async function carregarSaldos(){
      const res = await fetch(endpointSaldos); const saldos = await res.json();
      const grid = document.getElementById("saldosGrid"); grid.innerHTML="";
      saldos.forEach(s=>{
        const div=document.createElement("div");
        div.className="saldo-card";
        div.innerHTML=`${s.Empresa.toUpperCase()}<span>R$ ${Number(s.Saldo).toLocaleString("pt-BR",{minimumFractionDigits:2})}</span>`;
        grid.appendChild(div);
      });
    }

    async function carregarTitulos(){
      const tbody=document.querySelector("#tabelaTitulos tbody"); tbody.innerHTML="";
      const lista=document.getElementById("listaTitulos"); lista.innerHTML="";
      selecionados={}; let somaModalidades={};

      let url=endpointTitulos+"?action=listar";
      if(dataInicio) url+="&inicio="+dataInicio;
      if(dataFim) url+="&fim="+dataFim;
      const res = await fetch(url); const dados = await res.json();

      dados.titulos.forEach((item,i)=>{
        const valorNum=parseValor(item.valor);
        somaModalidades[item.meio_pagamento]=(somaModalidades[item.meio_pagamento]||0)+valorNum;

        // tabela
        const tr=document.createElement("tr");
        tr.innerHTML=`<td><input type="checkbox" onchange="toggleSelecionado(${i},${valorNum},this)"></td>
          <td><button class="btn-aprovar" onclick="atualizarStatus(${i},'Aprovado')">‚úì</button>
              <button class="btn-negar" onclick="atualizarStatus(${i},'Negado')">‚úó</button></td>
          <td>${item.empresa}</td><td>${item.fornecedor}</td>
          <td>${formatarData(item.vencimento)}</td>
          <td>R$ ${valorNum.toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
          <td>${item.meio_pagamento}</td><td>${item.historico}</td><td>${item.status||"Pendente"}</td>`;
        tbody.appendChild(tr);

        // mobile card
        const card=document.createElement("div");
        card.className="titulo-card";
        card.innerHTML=`<div class="titulo-header"><b>${item.empresa}</b>
          <div class="titulo-actions">
            <button class="btn-aprovar" onclick="atualizarStatus(${i},'Aprovado')">‚úì</button>
            <button class="btn-negar" onclick="atualizarStatus(${i},'Negado')">‚úó</button>
          </div></div>
          <div><b>Fornecedor:</b> ${item.fornecedor}</div>
          <div><b>Vencimento:</b> ${formatarData(item.vencimento)}</div>
          <div><b>Valor:</b> R$ ${valorNum.toLocaleString("pt-BR",{minimumFractionDigits:2})}</div>
          <div><b>Meio:</b> ${item.meio_pagamento}</div>
          <div><b>Hist√≥rico:</b> ${item.historico}</div>
          <div><b>Status:</b> ${item.status||"Pendente"}</div>`;
        lista.appendChild(card);
      });

      desenharGrafico(somaModalidades);
    }

    async function atualizarStatus(index,status){
      document.getElementById("overlay").style.display="flex";
      await fetch(endpointTitulos,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"atualizar",index,status})});
      await carregarTitulos();
      document.getElementById("overlay").style.display="none";
    }

    function desenharGrafico(soma){
      const ctx=document.getElementById("graficoModalidades").getContext("2d");
      if(grafico) grafico.destroy();
      grafico=new Chart(ctx,{type:"pie",data:{labels:Object.keys(soma),datasets:[{data:Object.values(soma),backgroundColor:["#2563eb","#16a34a","#dc2626","#f59e0b","#9333ea"]}]},
        options:{plugins:{legend:{position:"right"},datalabels:{color:"#fff",formatter:v=>"R$ "+v.toLocaleString("pt-BR",{minimumFractionDigits:2})}}},plugins:[ChartDataLabels]});
    }

    function toggleSelecionado(i,valor,chk){ if(chk.checked) selecionados[i]=valor; else delete selecionados[i]; }
    function toggleTodos(chk){ document.querySelectorAll("#tabelaTitulos tbody input[type=checkbox]").forEach(c=>{c.checked=chk.checked; c.dispatchEvent(new Event("change"));}); }

    function aplicarDatas(){ dataInicio=document.getElementById("dataInicio").value; dataFim=document.getElementById("dataFim").value; carregarTitulos(); }

    async function carregarTudo(){
      document.getElementById("overlay").style.display="flex";
      await carregarSaldos(); await carregarTitulos();
      document.getElementById("overlay").style.display="none";
    }

    window.onload=()=>{
      const hoje=new Date().toISOString().split("T")[0];
      document.getElementById("dataInicio").value=hoje;
      document.getElementById("dataFim").value=hoje;
      dataInicio=hoje; dataFim=hoje;
      carregarTudo();
    }
  </script>
</body>
</html>
