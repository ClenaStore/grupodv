<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel Financeiro • CAP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<style>
  :root{
    --bg:#0b1220;
    --card:#0f172a;
    --ink:#e5f0ff;
    --muted:#a8b3c7;
    --line:#243043;
    --teal:#06b6d4;
    --blue:#4f46e5;
    --green:#16a34a;
    --red:#ef4444;
    --amber:#f59e0b;
    --chip:#101a2e;
  }

  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}

  header{
    position:sticky;top:0;z-index:20;
    background:linear-gradient(180deg,#0f172a,#0b1220);
    border-bottom:1px solid var(--line);
    padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap
  }
  header h1{font-size:16px;margin:0;font-weight:800}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,input[type="date"]{
    background:#0b1528;border:1px solid #22314b;color:var(--ink);
    padding:8px 10px;border-radius:10px;font-size:13px
  }
  .container{padding:12px;max-width:1100px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px;margin-bottom:12px}
  .mods{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .mod{background:var(--chip);border:1px solid #22314b;border-radius:12px;padding:8px;font-size:13px;display:flex;justify-content:space-between}
  .lista{display:grid;gap:10px}
  .titulo{background:linear-gradient(180deg,#101a2f,#0f172a);border:1px solid var(--line);border-radius:14px;padding:10px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
  .info{display:grid;gap:4px}
  .row{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .row b{color:var(--ink)}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid #2a3955;background:#0b1528;font-size:12px;font-weight:800;color:#9ecbff}
  .pill.ok{border-color:#155e32;color:#b6f3c5;background:#0e2a1b}
  .pill.warn{border-color:#7a1e1e;color:#ffb4b4;background:#2a0e0e}
</style>
</head>
<body>
  <header>
    <h1>Painel Financeiro • CAP</h1>
    <div class="controls">
      <label style="font-size:12px">Status:</label>
      <select id="filtroStatus">
        <option value="Pendente">Pendentes</option>
        <option value="Aprovado" selected>Aprovados</option>
        <option value="Negado">Negados</option>
        <option value="Liquidado">Liquidados</option>
        <option value="Todos">Todos</option>
      </select>
      <input type="date" id="filtroDataInicio" />
      <input type="date" id="filtroDataFim" />
    </div>
  </header>

  <div class="container">
    <!-- apenas modalidades -->
    <div class="card">
      <div style="font-weight:800;margin-bottom:6px">Modalidades</div>
      <div id="mods" class="mods"></div>
    </div>

    <!-- lista -->
    <div class="lista" id="lista"></div>
  </div>

<script>
const endpointTitulos = "https://script.google.com/macros/s/AKfycbwt9y43T8Ya0AhNusue3PTekaBPDnrqSK33dsbnmOKezcm3wnSrUz3z2jO_9BoJd8MH/exec";
const EMP_DEFAULT = ["CAP DELICIA","CAP VILLA","CAP PADARIA","CAP MERCATTO","CAP M.KIDS"];

let TITULOS = {};

const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso=d=>new Date(d).toISOString().slice(0,10);

async function loadTitulos(empresas,inicioISO,fimISO,filtro){
  TITULOS={};
  const resps=await Promise.all(empresas.map(emp=>
    fetch(`${endpointTitulos}?action=listar&empresa=${encodeURIComponent(emp)}`)
      .then(r=>r.json().then(d=>({emp,data:d.titulos||d})))
  ));
  resps.forEach(({emp,data})=>{
    const arr=data.filter(t=>{
      const tDia=iso(t.vencimento);
      let st=(t.status==="Sim"?"Pendente":t.status);
      return (!inicioISO||tDia>=inicioISO) && (!fimISO||tDia<=fimISO) && (filtro==="Todos"||st===filtro);
    });
    TITULOS[emp]=arr;
  });
}

function renderLista(){
  const lista=$("lista"); lista.innerHTML="";
  const soma={};
  for(const emp of Object.keys(TITULOS)){
    (TITULOS[emp]||[]).forEach(t=>{
      const valor=Number(String(t.valor).replace("R$","").replace(/\./g,"").replace(",","."))||0;
      soma[t.meio_pagamento]=(soma[t.meio_pagamento]||0)+valor;
      const card=document.createElement("div");
      card.className="titulo";
      card.innerHTML=`
        <div class="info">
          <div class="row"><b>${t.fornecedor}</b> • ${emp}</div>
          <div class="row">Venc: <b>${iso(t.vencimento).split("-").reverse().join("/")}</b> • Valor: <b>${BRL(valor)}</b> • Meio: <b>${t.meio_pagamento}</b></div>
          <span class="pill ok">${t.status}</span>
        </div>`;
      lista.appendChild(card);
    });
  }
  renderModalidades(soma);
}

function renderModalidades(sum){
  const mods=$("mods"); mods.innerHTML="";
  const entries=Object.entries(sum);
  if(!entries.length){ mods.innerHTML="<div style='grid-column:1/-1;text-align:center;color:var(--muted)'>Sem dados</div>";return;}
  entries.forEach(([k,v])=>{
    const d=document.createElement("div");
    d.className="mod";
    d.innerHTML=`<span>${k}</span><b>${BRL(v)}</b>`;
    mods.appendChild(d);
  });
}

async function refresh(){
  const inicio=$("filtroDataInicio").value;
  const fim=$("filtroDataFim").value;
  const filtro=$("filtroStatus").value;
  await loadTitulos(EMP_DEFAULT,inicio,fim,filtro);
  renderLista();
}

(function boot(){
  const hoje=new Date();
  const inicioMes=new Date(hoje.getFullYear(),hoje.getMonth(),1).toISOString().slice(0,10);
  $("filtroDataInicio").value=inicioMes;
  $("filtroDataFim").value=hoje.toISOString().slice(0,10);
  $("filtroStatus").onchange=refresh;
  $("filtroDataInicio").onchange=refresh;
  $("filtroDataFim").onchange=refresh;
  refresh();
})();
</script>
</body>
</html>
