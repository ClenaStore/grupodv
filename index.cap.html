<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
<meta charset="UTF-8" />
<title>Aprova√ß√£o de CAP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<style>
/* üé® Vari√°veis globais iguais ao Delivery */
:root{
  --bg:#0b1020; --surface:#10172a; --card:#0f172a;
  --text:#e5e7eb; --muted:#94a3b8; --line:rgba(148,163,184,.25);
  --icon-bg:rgba(255,255,255,.06); --shadow:0 20px 60px rgba(2,6,23,.35);
  --brand:#60a5fa; --brand2:#22d3ee; --success:#16a34a;
  --danger:#dc2626; --orange:#f59e0b;
}
[data-theme="light"]{
  --bg:#f6f7fb; --surface:#fff; --card:#fff;
  --text:#0f172a; --muted:#475569; --line:#e5e7eb;
  --icon-bg:rgba(2,6,23,.06); --shadow:0 16px 36px rgba(15,23,42,.08);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  color:var(--text);
  font-size:15px
}

/* üñº Header */
header{
  position:sticky;top:0;z-index:40;
  backdrop-filter:saturate(160%) blur(8px);
  background:color-mix(in srgb, var(--surface) 80%, transparent);
  border-bottom:1px solid var(--line);
  padding:14px;
}
header .head{display:flex;align-items:center;gap:12px}
header .brand{display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--text);font-weight:800;font-size:16px}
header .grow{flex:1}
.btn{
  border:1px solid var(--line);
  background:var(--surface);
  color:var(--text);
  padding:8px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;
  font-size:14px;
  display:inline-flex;align-items:center;gap:6px;
}
.btn:hover{box-shadow:var(--shadow)}

/* Overlay de carregamento */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:100}
.spinner{width:74px;height:74px;border:6px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.container{padding:16px;max-width:1250px;margin:0 auto}

.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow);margin:14px 0}
.mods {display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(min-width:1024px){.mods{grid-template-columns:1fr 1fr 1fr}}
.mod{border-radius:12px;padding:14px;font-weight:700;display:flex;justify-content:space-between;align-items:center;color:#fff;font-size:16px}
.mod.total{background:var(--surface);border:1px solid var(--line)}
.mod.pix{background:linear-gradient(180deg,#3b82f6,#1e40af)}
.mod.cartao{background:linear-gradient(180deg,#22c55e,#15803d)}
.mod.boleto{background:linear-gradient(180deg,#9ca3af,#374151)}

.list-head{display:flex;align-items:center;justify-content:space-between;margin-top:10px;font-size:16px}
.lista{display:grid;gap:14px;margin-top:14px}
.titulo{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;gap:10px;position:relative}
.ck input{width:20px;height:20px}
.row{display:flex;gap:10px;flex-wrap:wrap;font-size:14px;color:var(--muted)}
.row b{color:var(--text)}
.row.hist{color:var(--orange);font-weight:600;font-size:13px}
.pill{padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:var(--surface);font-size:12px;font-weight:800;position:absolute;top:8px;right:8px}
.pill.ok{border-color:#155e32;color:#b6f3c5;background:#0e2a1b}
.pill.warn{border-color:#7a1e1e;color:#ffb4b4;background:#2a0e0e}

.actions{display:flex;gap:6px;flex-wrap:wrap}
.mini{flex:1 1 calc(50% - 6px);padding:8px;border-radius:12px;border:1px solid var(--line);background:var(--surface);color:var(--text);font-weight:700;cursor:pointer;font-size:14px;text-align:center}
.mini.aprovar{background:linear-gradient(180deg,#19c37d,#16a34a);color:#fff}
.mini.negar{background:linear-gradient(180deg,#fb6969,#ef4444);color:#fff}
.mini.obs{background:linear-gradient(180deg,#60a5fa,#1d4ed8);color:#fff}

.footer{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;align-items:flex-end;z-index:15}
.bubble{background:var(--brand);color:#fff;border-radius:8px;padding:6px 10px;font-weight:700;font-size:13px;display:none;box-shadow:0 2px 6px rgba(0,0,0,.3)}
.btn-massa{background:linear-gradient(180deg,var(--brand),var(--brand2));color:#002027;border:0;border-radius:8px;padding:6px 12px;font-weight:700;font-size:13px;cursor:pointer;display:none;box-shadow:0 2px 6px rgba(0,0,0,.3)}

.modal{position:fixed;inset:0;background:rgba(2,6,15,.65);display:none;align-items:center;justify-content:center;z-index:200}
.modal .box{background:var(--card);border:1px solid var(--line);border-radius:16px;max-width:95%;width:500px;padding:16px}
.modal h3{margin:0 0 12px;font-size:18px}
.modal .close{float:right;border:1px solid var(--line);background:var(--surface);border-radius:8px;color:var(--text);padding:6px 12px;cursor:pointer;font-size:14px}
textarea{width:100%;min-height:90px;border-radius:8px;border:1px solid var(--line);background:var(--surface);color:var(--text);padding:10px;font-size:14px}
</style>
</head>
<body>
<header>
  <div class="head">
    <a class="brand" href="#"><span>Aprova√ß√£o de CAP</span></a>
    <div class="grow"></div>
    <button id="themeToggle" class="btn">üåì Tema</button>
  </div>
  <div class="controls">
    <div class="row-filtros">
      <select id="filtroStatus">
        <option value="Pendente" selected>Pendentes</option>
        <option value="Aprovado">Aprovados</option>
        <option value="Negado">Negados</option>
        <option value="Liquidado">Liquidados</option>
        <option value="Todos">Todos</option>
      </select>
      <select id="filtroMeio">
        <option value="Todos" selected>Todos</option>
        <option value="Pix">Pix</option>
        <option value="Cart√£o">Cart√£o</option>
        <option value="Boleto">Boleto</option>
        <option value="Outros">Outros</option>
      </select>
    </div>
    <div class="row-linha">
      <input type="text" id="filtroPeriodo" placeholder="Selecione per√≠odo" />
      <div style="position:relative;flex:1">
        <button class="btn icon" id="btnEmpresas"><span id="empresaSelecionada">CAP DELICIA</span> ‚ñº</button>
        <div id="menuEmpresas" class="menu"></div>
      </div>
    </div>
  </div>
</header>

<div id="overlay"><div class="spinner"></div></div>

<div class="container">
  <div class="card">
    <div style="font-weight:800;margin-bottom:8px;font-size:16px">Modalidades</div>
    <div id="mods" class="mods"></div>
  </div>

  <div class="list-head">
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
      <input id="master" type="checkbox" />
      <b>Selecionar todos</b>
    </label>
    <div id="contagem" style="color:var(--muted);font-size:14px">0 itens</div>
  </div>

  <div id="lista" class="lista"></div>
</div>

<div class="footer">
  <div id="bubble" class="bubble">Total selecionado: R$ 0,00</div>
  <button id="btnMassa" class="btn-massa"><span>Aprovar selecionados</span></button>
</div>

<!-- modal observa√ß√£o -->
<div id="modalObs" class="modal">
  <div class="box">
    <button class="close" onclick="fecharObs()">Fechar</button>
    <h3>Observa√ß√£o</h3>
    <textarea id="textoObs" placeholder="Digite a observa√ß√£o..."></textarea>
    <button class="btn" style="margin-top:10px" onclick="salvarObs()"><span>Salvar</span></button>
  </div>
</div>
<script>

  /* üîò Toggle tema */
document.getElementById("themeToggle").onclick=()=>{
  const html=document.documentElement;
  html.dataset.theme=html.dataset.theme==="light"?"dark":"light";
};
const endpointTitulos="https://script.google.com/macros/s/AKfycbzJS4UkF6WZ-duyMJW_h3e5fo4Hev6Hq1a7rGhWNYCNJ6V_ou0lkN6wS49eeANf4Yuy/exec";
const EMP_DEFAULT=["CAP DELICIA","CAP VILLA","CAP PADARIA","CAP MERCATTO","CAP M.KIDS"];
let TITULOS={},SELEC=[],obsContext={};

const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso = d => { const dt=new Date(d); dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset()); return dt.toISOString().slice(0,10); };
const ID=(emp,linha)=>`${emp.replace(/\s+/g,'_')}__${linha}`;

function setLoading(btn,on=true){if(on)btn.classList.add("loading");else btn.classList.remove("loading");}

function normalizeMeio(meio){
  meio = (meio||"Outros").toLowerCase();
  if(meio.includes("pix")) return "Pix";
  if(meio.includes("cart")) return "Cart√£o";
  if(meio.includes("bol")) return "Boleto";
  return "Outros";
}

function addHistLocal(id,texto){
  let hist=JSON.parse(localStorage.getItem("hist_"+id)||"[]");
  hist.push({data:new Date().toLocaleString("pt-BR"),texto});
  localStorage.setItem("hist_"+id,JSON.stringify(hist));
}
function getHistLocal(id){return JSON.parse(localStorage.getItem("hist_"+id)||"[]");}

// üîπ Soma usa __all (sempre considerando o per√≠odo, ignorando Negados)
function renderMods(){
  const mods=$("mods");mods.innerHTML="";
  let soma={Pix:0,Cart√£o:0,Boleto:0,Outros:0,Total:0};
  for(const emp of Object.keys(TITULOS)){
    (TITULOS[emp].__all||[]).forEach(t=>{
      const status=(t.status||"Pendente");
      if(status==="Negado") return;
      const valor=Number(String(t.valor).replace("R$","").replace(/\./g,"").replace(",","."))||0;
      const meio=normalizeMeio(t.meio_pagamento);
      soma.Total+=valor;
      soma[meio]+=valor;
    });
  }
  const card=(cls,label,val)=>`<div class="mod ${cls}"><span>${label}</span><b>${BRL(val)}</b></div>`;
  mods.innerHTML+=card("pix","Pix",soma.Pix);
  mods.innerHTML+=card("cartao","Cart√£o",soma["Cart√£o"]);
  mods.innerHTML+=card("boleto","Boleto",soma.Boleto);
  mods.innerHTML+=card("total","Total",soma.Total);
}

function renderLista(){
  const lista=$("lista");lista.innerHTML="";SELEC=[];$("master").checked=false;
  let totalItens=0;
  for(const emp of Object.keys(TITULOS)){
    (TITULOS[emp].__filtered||[]).forEach((t)=>{
      totalItens++;
      const valor=Number(String(t.valor).replace("R$","").replace(/\./g,"").replace(",","."))||0;
      const id=ID(emp,t.linha);
      const st=(t.status || "Pendente");
      const obs=(t.observacao || "");
      const histColuna=(t.historico || "");
      const histLocal=getHistLocal(id);

      const card=document.createElement("div");
      card.className="titulo";card.dataset.id=id;card.dataset.emp=emp;card.dataset.linha=t.linha;card.dataset.valor=valor;
      card.innerHTML=`
        <div class="ck"><input type="checkbox" onchange="toggleSel(this)" /></div>
        <div class="info">
          <div class="row"><b>${t.fornecedor}</b> ‚Ä¢ ${emp}</div>
          <div class="row">Venc: <b>${iso(t.vencimento).split("-").reverse().join("/")}</b> ‚Ä¢ Meio: <b>${t.meio_pagamento||"Outros"}</b></div>
          <div class="row">Valor: <b>${BRL(valor)}</b></div>
          ${obs ? `<div class="row obs" style="color:#60a5fa">Obs (planilha): ${obs}</div>` : ""}
          ${histLocal.length ? `<div class="row obs" style="color:#a8b3c7">Obs (local): ${histLocal.map(h=>h.texto).join("<br>")}</div>` : ""}
          ${histColuna ? `<div class="row hist">Hist√≥rico F360: ${histColuna}</div>` : ""}
        </div>
        <span class="pill" data-status>${st}</span>
        <div class="actions">
          <button class="mini obs" onclick="abrirObs('${id}','${emp}',${t.linha},\`${obs}\`,'${t.fornecedor}')"><span>‚úèÔ∏è Obs</span><div class="spinner-btn"></div></button>
          <button class="mini negar" onclick="acaoStatus(this,'Negado')"><span>‚úó Negar</span><div class="spinner-btn"></div></button>
          <button class="mini aprovar" onclick="acaoStatus(this,'Aprovado')"><span>‚úì Aprovar</span><div class="spinner-btn"></div></button>
        </div>`;

      card.addEventListener("dblclick", ()=>{
        const chk = card.querySelector(".ck input");
        chk.checked = !chk.checked;
        toggleSel(chk);
      });

      setPill(card.querySelector("[data-status]"),st);
      lista.appendChild(card);
    });
  }
  $("contagem").textContent=`${totalItens} ${totalItens===1?"item":"itens"}`;
  renderMods();
}

function setPill(el,status){
  el.className="pill";
  if(status==="Aprovado"){el.classList.add("ok");el.textContent="Aprovado"}
  else if(status==="Negado"){el.classList.add("warn");el.textContent="Negado"}
  else el.textContent=status;
}

function toggleSel(chk){
  const card=chk.closest(".titulo");
  const id=card.dataset.id,emp=card.dataset.emp,linha=Number(card.dataset.linha),valor=Number(card.dataset.valor)||0;
  if(chk.checked)SELEC.push({id,emp,linha,valor}); else SELEC=SELEC.filter(x=>x.id!==id);
  const total=SELEC.reduce((s,x)=>s+x.valor,0);
  if(SELEC.length){$("bubble").style.display="block";$("btnMassa").style.display="block";$("bubble").textContent="Total selecionado: "+BRL(total)}
  else{$("bubble").style.display="none";$("btnMassa").style.display="none"}
}

// üîπ Sele√ß√£o em massa
$("master").addEventListener("change",function(){
  const chks=document.querySelectorAll(".titulo .ck input");
  chks.forEach(chk=>{
    chk.checked=this.checked;
    toggleSel(chk);
  });
});

async function acaoStatus(btn,novo){
  const card=btn.closest(".titulo");
  const emp=card.dataset.emp,linha=card.dataset.linha,id=card.dataset.id;
  setLoading(btn,true);
  setPill(card.querySelector("[data-status]"),novo);
  addHistLocal(id,"Status alterado para "+novo);
  try{await fetch(`${endpointTitulos}?action=atualizar&empresa=${encodeURIComponent(emp)}&linha=${linha}&status=${encodeURIComponent(novo)}`);}catch(e){console.error(e)}
  setLoading(btn,false);
}

async function atualizarStatusMassa(novo="Aprovado"){
  const btn=$("btnMassa");
  setLoading(btn,true);
  for(const s of SELEC){
    const card=document.querySelector(`.titulo[data-id="${s.id}"]`);
    if(!card) continue;
    setPill(card.querySelector("[data-status]"),novo);
    addHistLocal(s.id,"Status alterado para "+novo);
    try{
      await fetch(`${endpointTitulos}?action=atualizar&empresa=${encodeURIComponent(s.emp)}&linha=${s.linha}&status=${encodeURIComponent(novo)}`);
    }catch(e){console.error(e)}
    card.querySelector(".ck input").checked=false;
  }
  SELEC=[];$("master").checked=false;
  $("bubble").style.display="none";$("btnMassa").style.display="none";
  setLoading(btn,false);
}
$("btnMassa").onclick=()=>atualizarStatusMassa("Aprovado");

function abrirObs(id,emp,linha,txt,fornecedor){
  obsContext={id,emp,linha};
  $("textoObs").value=txt||"";
  $("modalObs").style.display="flex";
  $("modalObs").querySelector("h3").textContent = "Observa√ß√£o - " + fornecedor;
}

function fecharObs(){$("modalObs").style.display="none"}
async function salvarObs(){
  const {id,emp,linha}=obsContext;
  const texto=$("textoObs").value.trim();
  if(!texto)return;
  const btn=$("modalObs").querySelector(".btn");
  setLoading(btn,true);
  addHistLocal(id,"Obs pendente: "+texto);
  renderLista();
  try{
    const resp = await fetch(`${endpointTitulos}?action=atualizarObservacao&empresa=${encodeURIComponent(emp)}&linha=${linha}&texto=${encodeURIComponent(texto)}`);
    if(resp.ok){
      localStorage.removeItem("hist_"+id);
      const card=document.querySelector(`.titulo[data-id="${id}"]`);
      if(card){
        const info=card.querySelector(".info");
        info.querySelectorAll(".row.obs").forEach(e=>e.remove());
        const div=document.createElement("div");
        div.className="row obs";div.style.color="#60a5fa";
        div.textContent="Obs (planilha): "+texto;
        info.appendChild(div);
      }
    }
  }catch(e){console.error(e)}
  setLoading(btn,false);
  fecharObs();
}

async function loadTitulos(empresas,inicio,fim,filtroStatus,filtroMeio){
  TITULOS={};$("overlay").style.display="flex";
  const resps=await Promise.all(empresas.map(emp=>
    fetch(`${endpointTitulos}?action=listar&empresa=${encodeURIComponent(emp)}`)
      .then(r=>r.json().then(d=>({emp,data:d.titulos||d})))
  ));
  resps.forEach(({emp,data})=>{
    const all=data.filter(t=>{const d=iso(t.vencimento);return (!inicio||d>=inicio)&&(!fim||d<=fim);});
    const filtered=all.filter(t=>{
      let st=(t.status||"Pendente");
      const meio=normalizeMeio(t.meio_pagamento);
      const statusOk=filtroStatus==="Todos"?true:(st===filtroStatus);
      const meioOk=filtroMeio==="Todos"?true:(meio===filtroMeio);
      return statusOk&&meioOk;
    });
    TITULOS[emp]={__all:all,__filtered:filtered};
  });
  $("overlay").style.display="none";
}
async function refresh(inicio,fim){
  const filtro=$("filtroStatus").value;
  const filtroMeio=$("filtroMeio").value;
  const empresa=document.querySelector("#menuEmpresas input:checked").value;
  await loadTitulos([empresa],inicio,fim,filtro,filtroMeio);
  $("empresaSelecionada").textContent=empresa;
  renderLista();
}

(function boot(){
  const hoje = new Date(); // objeto Date do dia atual
  flatpickr("#filtroPeriodo", {
    mode: "range",
    dateFormat: "d/m/Y", // formato brasileiro
    locale: "pt",
    defaultDate: [hoje, hoje], // agora pega o dia atual certo
    onClose: sel=>{
      if(sel.length===2){
        const [ini,fim] = sel.map(d => iso(d));
        refresh(ini,fim);
      }
    }
  });

  const M=$("menuEmpresas");
EMP_DEFAULT.forEach((emp,i)=>{
  const lbl=document.createElement("label");
  lbl.style.display = "flex";
  lbl.style.alignItems = "center";
  lbl.style.gap = "8px"; // espa√ßo entre bolinha e texto
  lbl.innerHTML = `<input type="radio" name="empresaSel" value="${emp}" ${i===0?"checked":""}><span>${emp}</span>`;
  lbl.querySelector("input").onchange = ()=>{refresh(iso(hoje),iso(hoje));M.style.display="none"};
  M.appendChild(lbl);
});


  $("btnEmpresas").onclick=(e)=>{e.stopPropagation();M.style.display=M.style.display==="block"?"none":"block";};
  document.addEventListener("click",(e)=>{if(!M.contains(e.target)&&e.target.id!=="btnEmpresas"){M.style.display="none";}});
  $("filtroStatus").onchange=()=>refresh(iso(hoje),iso(hoje));
  $("filtroMeio").onchange=()=>refresh(iso(hoje),iso(hoje));
  refresh(iso(hoje),iso(hoje));
})();

</script>
</body>
</html>
