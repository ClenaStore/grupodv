<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel Financeiro • CAP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<style>
  :root{
    --bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;--line:#243043;
    --teal:#06b6d4;--blue:#4f46e5;--green:#16a34a;--red:#ef4444;--amber:#f59e0b;--chip:#101a2e;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}

  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0f172a,#0b1220);
    border-bottom:1px solid var(--line);padding:10px 12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
  header h1{font-size:16px;margin:0;font-weight:800}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,input[type="date"]{background:#0b1528;border:1px solid #22314b;color:var(--ink);
    padding:8px 10px;border-radius:10px;font-size:13px}
  .btn{border:1px solid #2a3955;background:#0b1528;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn.icon{display:flex;align-items:center;gap:6px}

  /* loader */
  #overlay{position:fixed;inset:0;background:rgba(3,7,18,.55);backdrop-filter:blur(2px);
    display:none;align-items:center;justify-content:center;z-index:100}
  .spinner{width:48px;height:48px;border:6px solid var(--teal);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .container{padding:12px;max-width:1100px;margin:0 auto}

  /* Modalidades */
  .mods-card{margin:12px 0;background:#0f172a;border:1px solid var(--line);border-radius:14px;padding:12px}
  .mods{display:grid;grid-template-columns:1fr;gap:8px}
  @media(min-width:768px){.mods{grid-template-columns:1fr 1fr}}
  @media(min-width:1024px){.mods{grid-template-columns:1fr 1fr 1fr}}
  .mod{border-radius:12px;padding:10px;font-weight:700;display:flex;justify-content:space-between;align-items:center;color:#fff}
  .mod.total{background:#0f172a;border:1px solid var(--line)}
  .mod.boleto{background:linear-gradient(180deg,#a855f7,#6b21a8)}
  .mod.pix{background:linear-gradient(180deg,#06b6d4,#0e7490)}
  .mod.cartao{background:linear-gradient(180deg,#4f46e5,#312e81)}

  /* Lista */
  .list-head{display:flex;align-items:center;justify-content:space-between;margin-top:6px}
  .list-head .left{display:flex;gap:8px;align-items:center}
  .master{width:18px;height:18px}
  .lista{display:grid;gap:10px;margin-top:10px}
  .titulo{background:linear-gradient(180deg,#101a2f,#0f172a);border:1px solid var(--line);
    border-radius:14px;padding:10px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
  .ck{display:flex;align-items:center;justify-content:center}
  .ck input{width:18px;height:18px}
  .info{display:grid;gap:4px}
  .row{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
  .row b{color:var(--ink)}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid #2a3955;background:#0b1528;font-size:12px;font-weight:800}
  .pill.ok{border-color:#155e32;color:#b6f3c5;background:#0e2a1b}
  .pill.warn{border-color:#7a1e1e;color:#ffb4b4;background:#2a0e0e}
  .actions{display:flex;gap:6px}
  .mini{padding:6px 9px;border-radius:10px;border:1px solid #22314b;background:#0b1528;color:#fff;font-weight:800;cursor:pointer;position:relative}
  .mini.aprovar{background:linear-gradient(180deg,#19c37d,#16a34a)}
  .mini.negar{background:linear-gradient(180deg,#fb6969,#ef4444)}
  .mini.hist{background:linear-gradient(180deg,#ffd166,#f59e0b);color:#2a1500}
  .mini.loading{opacity:.75;pointer-events:none}
  .mini.loading::after{content:"";width:12px;height:12px;border:2px solid #fff;border-top-color:transparent;
    border-radius:50%;animation:spin .8s linear infinite;position:absolute;right:6px;top:50%;transform:translateY(-50%)}

  /* Footer */
  .footer{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:10px;align-items:flex-end;z-index:15}
  .bubble{background:var(--blue);color:#fff;border-radius:12px;padding:8px 12px;font-weight:800;box-shadow:0 12px 30px rgba(79,70,229,.35)}
  .btn-massa{background:linear-gradient(180deg,var(--teal),#0796ad);color:#002027;border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}

  /* Menu empresas */
  .menu{position:fixed;top:60px;right:10px;background:#0f172a;border:1px solid var(--line);
    border-radius:12px;padding:10px;box-shadow:0 10px 30px rgba(0,0,0,.4);display:none;z-index:30}
  .menu label{display:block;font-size:13px;margin:6px 0}
</style>
</head>
<body>
  <header>
    <h1>Painel Financeiro • CAP</h1>
    <div class="controls">
      <label for="filtroStatus" style="font-size:12px">Status:</label>
      <select id="filtroStatus">
        <option value="Pendente" selected>Pendentes</option>
        <option value="Aprovado">Aprovados</option>
        <option value="Negado">Negados</option>
        <option value="Liquidado">Liquidados</option>
        <option value="Todos">Todos</option>
      </select>
      <input type="date" id="filtroInicio" />
      <input type="date" id="filtroFim" />
      <button class="btn icon" id="btnEmpresas">Empresa: <span id="empresaSelecionada">CAP DELICIA</span> ▼</button>
    </div>
  </header>

  <div id="overlay"><div class="spinner"></div></div>
  <div id="menuEmpresas" class="menu"></div>

  <div class="container">
    <!-- Modalidades -->
    <div class="mods-card">
      <div style="font-weight:800;margin-bottom:6px">Modalidades</div>
      <div id="mods" class="mods"></div>
    </div>

    <!-- lista -->
    <div class="list-head">
      <div class="left">
        <input id="master" class="master" type="checkbox" />
        <div style="font-weight:900">Títulos</div>
      </div>
      <div id="contagem" style="color:var(--muted);font-size:12px">0 itens</div>
    </div>
    <div id="lista" class="lista"></div>
  </div>

  <!-- footer -->
  <div class="footer">
    <div id="bubble" class="bubble" style="display:none">Total selecionado: R$ 0,00</div>
    <button id="btnMassa" class="btn-massa" style="display:none">Aprovar selecionados</button>
  </div>

<script>
const endpointTitulos="https://script.google.com/macros/s/AKfycbwt9y43T8Ya0AhNusue3PTekaBPDnrqSK33dsbnmOKezcm3wnSrUz3z2jO_9BoJd8MH/exec";
const EMP_DEFAULT=["CAP DELICIA","CAP VILLA","CAP PADARIA","CAP MERCATTO","CAP M.KIDS"];

let TITULOS={},SELEC=[];
const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso=d=>new Date(d).toISOString().slice(0,10);
const ID=(emp,idx)=>`${emp.replace(/\s+/g,'_')}__${idx}`;

function showOverlay(){$("overlay").style.display="flex"}
function hideOverlay(){$("overlay").style.display="none"}

$("btnEmpresas").onclick=()=>{const m=$("menuEmpresas");m.style.display=(m.style.display==="block"?"none":"block")};
document.addEventListener("click",e=>{const m=$("menuEmpresas");if(!m.contains(e.target)&&e.target!==$("btnEmpresas"))m.style.display="none"});

async function loadTitulos(empresas,inicio,fim,filtro){
  TITULOS={};
  const resps=await Promise.all(empresas.map(emp=>
    fetch(`${endpointTitulos}?action=listar&empresa=${encodeURIComponent(emp)}`)
    .then(r=>r.json().then(d=>({emp,data:d.titulos||d})))
  ));
  resps.forEach(({emp,data})=>{
    const all=data.filter(t=>{
      const d=iso(t.vencimento);
      return (!inicio||d>=inicio)&&(!fim||d<=fim);
    });
    const arr=all.filter(t=>{
      let st=(t.status==="Sim"?"Pendente":t.status);
      return filtro==="Todos"?true:(st===filtro);
    });
    TITULOS[emp]=arr;
  });
}

function renderLista(){
  const lista=$("lista");lista.innerHTML="";SELEC=[];$("master").checked=false;
  let totalItens=0,somaModal={};
  for(const emp of Object.keys(TITULOS)){
    const arr=TITULOS[emp]||[];
    arr.forEach((t,idx)=>{
      totalItens++;
      const valor=Number(String(t.valor).replace("R$","").replace(/\./g,"").replace(",","."));
      const meio=t.meio_pagamento||"Outros";
      somaModal[meio]=(somaModal[meio]||0)+valor;
      const id=ID(emp,idx);
      const st=(t.status==="Sim"?"Pendente":t.status);
      const card=document.createElement("div");
      card.className="titulo";card.dataset.id=id;card.dataset.emp=emp;card.dataset.idx=idx;
      card.innerHTML=`
        <div class="ck"><input type="checkbox" onchange="toggleSel(this)" /></div>
        <div class="info">
          <div class="row"><b>${t.fornecedor}</b> • ${emp}</div>
          <div class="row">Venc: <b>${iso(t.vencimento).split("-").reverse().join("/")}</b> • Meio: <b>${meio}</b></div>
          <div class="row">Valor: <b>${BRL(valor)}</b> <span class="pill" data-status></span></div>
        </div>
        <div class="actions">
          <button class="mini aprovar" onclick="acaoStatus(this,'Aprovado')">✓</button>
          <button class="mini negar" onclick="acaoStatus(this,'Negado')">✗</button>
          <button class="mini hist" onclick="abrirHist('${id}')">H</button>
        </div>`;
      setPill(card.querySelector("[data-status]"),st);
      card.dataset.valor=valor;
      lista.appendChild(card);
    });
  }
  $("contagem").textContent=`${totalItens} ${totalItens===1?"item":"itens"}`;
  renderModalidades(somaModal);
}

function setPill(el,status){
  el.className="pill";
  if(status==="Aprovado"){el.classList.add("ok");el.textContent="Aprovado"}
  else if(status==="Negado"){el.classList.add("warn");el.textContent="Negado"}
  else el.textContent=status;
}

function renderModalidades(sum){
  const mods=$("mods");mods.innerHTML="";
  let grupos={Cartão:0,Boleto:0,Pix:0};
  for(const [k,v] of Object.entries(sum)){
    const txt=k.toLowerCase();
    if(txt.includes("cred")||txt.includes("déb")||txt.includes("deb")||txt.includes("cart"))grupos["Cartão"]+=v;
    else if(txt.includes("bol"))grupos["Boleto"]+=v;
    else if(txt.includes("pix"))grupos["Pix"]+=v;
  }
  let total=0;
  const cores={Cartão:"cartao",Boleto:"boleto",Pix:"pix"};
  for(const g of Object.keys(grupos)){
    total+=grupos[g];
    const d=document.createElement("div");
    d.className="mod "+cores[g];
    d.innerHTML=`<span>${g}</span><b>${BRL(grupos[g])}</b>`;
    mods.appendChild(d);
  }
  const totalDiv=document.createElement("div");
  totalDiv.className="mod total";
  totalDiv.innerHTML=`<span>Total</span><b>${BRL(total)}</b>`;
  mods.appendChild(totalDiv);
}

/* Seleção */
$("master").onchange=()=>{document.querySelectorAll("#lista .ck input").forEach(cb=>{cb.checked=$("master").checked;cb.dispatchEvent(new Event("change"))})};
function toggleSel(chk){
  const card=chk.closest(".titulo");
  const id=card.dataset.id,emp=card.dataset.emp,idx=Number(card.dataset.idx);
  const valor=Number(card.dataset.valor)||0;
  if(chk.checked)SELEC.push({id,emp,idx,valor});
  else SELEC=SELEC.filter(x=>x.id!==id);
  renderSelecionados();
}
function renderSelecionados(){
  const total=SELEC.reduce((s,x)=>s+x.valor,0);
  if(SELEC.length){$("bubble").style.display="block";$("btnMassa").style.display="block";$("bubble").textContent="Total selecionado: "+BRL(total)}
  else{$("bubble").style.display="none";$("btnMassa").style.display="none"}
}

/* Aprovar/Negar */
async function acaoStatus(btn,novo){
  const card=btn.closest(".titulo");
  const id=card.dataset.id,emp=card.dataset.emp,idx=Number(card.dataset.idx),valor=Number(card.dataset.valor)||0;
  btn.classList.add("loading");
  setPill(card.querySelector("[data-status]"),novo);
  try{await fetch(`${endpointTitulos}?action=atualizar&empresa=${encodeURIComponent(emp)}&index=${idx}&status=${encodeURIComponent(novo)}`)}catch(e){console.error(e)}
  btn.classList.remove("loading");
}

/* Boot */
async function refresh(){
  showOverlay();
  const inicio=$("filtroInicio").value,fim=$("filtroFim").value,filtro=$("filtroStatus").value;
  const empresa=document.querySelector("#menuEmpresas input:checked").value;
  await loadTitulos([empresa],inicio,fim,filtro);
  $("empresaSelecionada").textContent=empresa;
  renderLista();hideOverlay();
}
(function boot(){
  const hoje=new Date().toISOString().slice(0,10);
  $("filtroInicio").value=hoje;$("filtroFim").value=hoje;
  const M=$("menuEmpresas");M.innerHTML="";
  EMP_DEFAULT.forEach((emp,i)=>{
    const lbl=document.createElement("label");
    lbl.innerHTML=`<input type="radio" name="empresaSel" value="${emp}" ${i===0?"checked":""}/> ${emp}`;
    lbl.querySelector("input").onchange=refresh;M.appendChild(lbl);
  });
  $("filtroStatus").onchange=refresh;
  $("filtroInicio").onchange=refresh;$("filtroFim").onchange=refresh;
  refresh();
})();
</script>
</body>
</html>
