<!-- popup.html -->
<style>
h3{font-size:18px;margin-top:0;margin-bottom:10px;display:flex;align-items:center;gap:6px}
table{width:100%;border-collapse:collapse;font-size:14px;margin-top:10px}
th,td{border:1px solid #334155;padding:8px 10px;text-align:left}
th{background:#1e293b;color:#fff;position:sticky;top:0}
tr:nth-child(even){background:#162032}
.flag{width:32px;height:32px;border-radius:50%;display:inline-flex;align-items:center;
  justify-content:center;color:#fff;font-size:18px;margin:4px;cursor:pointer}
.flag.verde{background:#16a34a}
.flag.vermelha{background:#ef4444}
</style>

<h3>ðŸ“‹ Tabela Completa CAP</h3>
<table id="tabelaCAP">
  <thead>
    <tr>
      <th>Fornecedor</th>
      <th>Vencimento</th>
      <th>Valor</th>
      <th>Meio</th>
      <th>Status</th>
      <th style="text-align:center">AÃ§Ãµes</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="6" style="text-align:center;color:#94a3b8;">Carregando dados...</td></tr>
  </tbody>
</table>

<script>
// ðŸ”¹ FunÃ§Ã£o que preenche a tabela com os dados recebidos do GAS
function preencherTabelaPopup(lista){
  const tbody = document.querySelector("#tabelaCAP tbody");
  tbody.innerHTML = "";

  if(!lista.length){
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#94a3b8;">Nenhum registro encontrado</td></tr>`;
    return;
  }

  lista.forEach(t=>{
    const tr = document.createElement("tr");
    const venc = t.vencimento ? new Date(t.vencimento).toLocaleDateString("pt-BR") : "-";
    const valor = parseFloat(t.valor||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    tr.innerHTML = `
      <td>${t.fornecedor||"-"}</td>
      <td>${venc}</td>
      <td>${valor}</td>
      <td>${t.meio_pagamento||"-"}</td>
      <td>${t.status||"Pendente"}</td>
      <td style="text-align:center">
        <span class="flag verde" title="Aprovar" onclick="acaoTabelaPopup('${t.empresa}','${t.linha}','Aprovado')">âœ…</span>
        <span class="flag vermelha" title="Negar" onclick="acaoTabelaPopup('${t.empresa}','${t.linha}','Negado')">âœ–</span>
      </td>`;
    tbody.appendChild(tr);
  });
}

// ðŸ”¹ Atualiza status direto no GAS
async function acaoTabelaPopup(emp,linha,status){
  try{
    const url = `https://script.google.com/macros/s/AKfycbzUfUXj5b9QB6v02RhshJCFeIzDT_DwihSYDdtgctANVpqFZol6dDe4WXfuYu7b9CKB/exec?action=atualizar&empresa=${encodeURIComponent(emp)}&linha=${linha}&status=${encodeURIComponent(status)}`;
    await fetch(url);
    alert(`âœ… ${emp} atualizado para ${status}`);
  }catch(e){
    alert("Erro ao atualizar: "+e);
  }
}
</script>
