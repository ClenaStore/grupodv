<script>
async function abrirPopupTabela() {
  const overlay = document.getElementById("popupOverlay");
  const content = document.getElementById("popupContent");
  overlay.style.display = "flex";

  const empresaSel = document.querySelector("#menuEmpresas input:checked")?.value || "CAP DELICIA";
  content.innerHTML = `
    <div style="color:#fff;text-align:center;padding:20px;font-size:15px;">
      ‚è≥ Carregando dados de <b>${empresaSel}</b>...
    </div>
  `;

  try {
    const url = `${endpointTitulos}?action=listar&empresa=${encodeURIComponent(empresaSel)}`;
    const resp = await fetch(url);
    const json = await resp.json();
    const titulos = json.titulos || [];

    // Monta estrutura HTML do popup
    let html = `
      <h3 style="margin-top:0;font-size:18px;color:#fff;">
        üìã Tabela Completa - ${empresaSel}
      </h3>
      <table style="width:100%;border-collapse:collapse;font-size:14px;margin-top:10px;">
        <thead style="background:#1e293b;color:#fff;">
          <tr>
            <th style="padding:8px;border:1px solid #334155;">Fornecedor</th>
            <th style="padding:8px;border:1px solid #334155;">Vencimento</th>
            <th style="padding:8px;border:1px solid #334155;">Valor</th>
            <th style="padding:8px;border:1px solid #334155;">Meio</th>
            <th style="padding:8px;border:1px solid #334155;">Status</th>
            <th style="padding:8px;border:1px solid #334155;">Hist√≥rico</th>
            <th style="padding:8px;border:1px solid #334155;text-align:center;">A√ß√µes</th>
          </tr>
        </thead>
        <tbody style="color:#e2e8f0;background:#0f172a;">
    `;

    if (!titulos.length) {
      html += `
        <tr>
          <td colspan="7" style="text-align:center;padding:10px;color:#94a3b8;">
            Nenhum registro encontrado
          </td>
        </tr>`;
    } else {
      titulos.forEach(t => {
        const venc = t.vencimento ? new Date(t.vencimento).toLocaleDateString("pt-BR") : "-";
        const valor = parseFloat(t.valor || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        const meio = t.meio_pagamento || "Outros";
        const status = t.status || "Pendente";
        const hist = t.historico || "-";
        const obs = t.observacao ? `<div style='color:#60a5fa;font-size:13px;'>Obs: ${t.observacao}</div>` : "";

        html += `
          <tr>
            <td style="border:1px solid #334155;padding:6px;">${t.fornecedor || "-"}</td>
            <td style="border:1px solid #334155;padding:6px;">${venc}</td>
            <td style="border:1px solid #334155;padding:6px;">${valor}</td>
            <td style="border:1px solid #334155;padding:6px;">${meio}</td>
            <td style="border:1px solid #334155;padding:6px;">${status}</td>
            <td style="border:1px solid #334155;padding:6px;">${hist}${obs}</td>
            <td style="border:1px solid #334155;padding:6px;text-align:center;">
              <button style="background:#16a34a;color:#fff;border:0;padding:5px 10px;border-radius:6px;cursor:pointer;margin-right:4px;"
                onclick="atualizarStatusPopup('${empresaSel}',${t.linha},'Aprovado')">‚úì</button>
              <button style="background:#ef4444;color:#fff;border:0;padding:5px 10px;border-radius:6px;cursor:pointer;"
                onclick="atualizarStatusPopup('${empresaSel}',${t.linha},'Negado')">‚úó</button>
            </td>
          </tr>`;
      });
    }

    html += `</tbody></table>`;
    content.innerHTML = html;

  } catch (e) {
    console.error(e);
    content.innerHTML = `
      <div style="color:#f87171;text-align:center;padding:20px;">
        ‚ùå Erro ao buscar dados do GAS<br><small>${e.message}</small>
      </div>`;
  }
}

// Atualiza status no GAS e recarrega tabela
async function atualizarStatusPopup(emp, linha, status) {
  try {
    const url = `${endpointTitulos}?action=atualizar&empresa=${encodeURIComponent(emp)}&linha=${linha}&status=${encodeURIComponent(status)}`;
    await fetch(url);
    alert(`‚úÖ ${emp} - linha ${linha} atualizada para ${status}`);
    abrirPopupTabela(); // recarrega automaticamente ap√≥s a√ß√£o
  } catch (e) {
    alert("Erro ao atualizar: " + e);
  }
}

function fecharPopupTabela() {
  document.getElementById("popupOverlay").style.display = "none";
}
</script>
